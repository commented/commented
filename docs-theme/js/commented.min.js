(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){

var Commented = require('./lib')

document.addEventListener('DOMContentLoaded', function () {
  var node = document.getElementById('commented-main');
  if (!node) {
    console.error('#commented node not found');
    return;
  }
  var options = {
    firebase: node.getAttribute('data-firebase'),
    type: 'firebase',
    auth: node.getAttribute('data-auth').split(' '),
    slug: node.getAttribute('data-slug') || window.location + '',
    inline: node.getAttribute('data-inline'),
    main: node
  }

  // firebase is currently the only supported host
  if (!options.firebase) {
    console.error('Invalid configuration! data-firebase must be specified')
    return;
  }
  Commented(options);
});


},{"./lib":11}],2:[function(require,module,exports){
/** @jsx React.DOM */
var Login = require('./login.jsx')
  , CreateComment = require('./create-comment.jsx')

var AddComment = React.createClass({displayName: 'AddComment',
  propTypes: {
    user: React.PropTypes.object.isRequired,
    autoAdd: React.PropTypes.bool,
  },
  getInitialState: function () {
    return {
      adding: false
    }
  },
  onShow: function () {
    this.setState({adding: true});
  },
  onHide: function () {
    this.setState({adding: false});
  },
  render: function () {
    if (!this.state.adding && !this.props.autoAdd) {
      return React.DOM.div( {className:"add-comment", onClick:this.onShow}, 
        "Add a comment"
      )
    }
    if (!this.props.user) {
      return Login( {db:this.props.db, auth:this.props.auth, onCancel:this.onHide})
    }
    return CreateComment(
      {onHide:this.onHide,
      target:this.props.target,
      db:this.props.db,
      user:this.props.user})
  }
});

module.exports = AddComment

},{"./create-comment.jsx":7,"./login.jsx":12}],3:[function(require,module,exports){
/** @jsx React.DOM */
var AutoTextarea = React.createClass({displayName: 'AutoTextarea',
  componentDidMount: function () {
    var node = this.getDOMNode()
    node.style.height = 'auto'
    node.style.height = node.scrollHeight + 'px'
    node.style.scrollTop = node.scrollHeight
    node.focus()
    node.selectionStart = node.selectionEnd = node.value.length
  },

  render: function () {
    var style
      , node

    if (this.isMounted()) {
      node = this.getDOMNode()
      node.style.height = 'auto'
      node.style.height = node.scrollHeight + 'px'
      style = {
        height: node.scrollHeight + 'px',
        scrollTop: node.scrollHeight
      }
    }
    return this.transferPropsTo(
      React.DOM.textarea( {style:style, className:"auto-textarea"})
    )
  }
});

module.exports = AutoTextarea

},{}],4:[function(require,module,exports){

module.exports = cleanSlug

function cleanSlug(slug) {
  return slug.replace(/[^a-zA-Z0-9]/gm, '-')
}

},{}],5:[function(require,module,exports){
/** @jsx React.DOM */
var format = require('./format')
  , AutoTextarea = require('./auto-textarea.jsx')
  , ReplyLogin = require('./reply-login.jsx')
  , cx = React.addons.classSet

var CommentDisplay = React.createClass({displayName: 'CommentDisplay',
  propTypes: {
    editing: React.PropTypes.bool.isRequired,
    canEdit: React.PropTypes.bool.isRequired,
    data: React.PropTypes.object.isRequired,
    isReply: React.PropTypes.bool,

    onEdit: React.PropTypes.func,
    doneEditing: React.PropTypes.func,
    onRemove: React.PropTypes.func,

    onReply: React.PropTypes.func,
    onUpvote: React.PropTypes.func,
    onDownvote: React.PropTypes.func,
    onClearVote: React.PropTypes.func,
    onFlag: React.PropTypes.func,
  },

  getInitialState: function () {
    return {
      text: this.props.data.text,
    }
  },

  cancelEdit: function () {
    this.setState({text: this.props.data.text})
    this.props.cancelEdit()
  },

  doneEditing: function () {
    this.props.doneEditing(this.state.text)
  },

  onChange: function (e) {
    this.setState({text: e.target.value});
  },

  getVotes: function () {
    var votes = {
      up: false,
      upCount: 0,
      down: false,
      downCount: 0,
      flagged: this.props.data.flags && this.props.data.flags[this.props.userid],
      flagCount: 0
    }

    switch (this.props.data.votes && this.props.data.votes[this.props.userid]) {
      case true:
        votes.up = true; break;
      case false:
        votes.down = true; break;
      default: break;
    }
    for (var id in this.props.data.votes) {
      if (this.props.data.votes[id]) {
        votes.upCount += 1
      } else {
        votes.downCount += 1
      }
    }
    for (var id in this.props.data.flags) {
      if (this.props.data.flags[id]) {
        votes.flagCount += 1
      }
    }
    return votes
  },

  voteButtons: function (votes) {
    if (!this.props.canVote) return

    return React.DOM.div( {className:"commented_buttons"}, 
      React.DOM.span(
        {onClick:this.props.onFlag.bind(null, !votes.flagged),
        className:cx({
          "button commented_flag": true,
          "commented_flag--active": votes.flagged
        })}, 
        React.DOM.i( {className:"fa fa-flag"})
      ),
      React.DOM.span(
        {onClick:votes.down ? this.props.onClearVote : this.props.onDownvote,
        className:cx({
          "button commented_down": true,
          "commented_down--shown shown": !!votes.downCount,
          "commented_down--active active": votes.down
        })}, 
        React.DOM.span( {className:"count"}, votes.downCount),
        React.DOM.i( {className:"fa fa-thumbs-o-down"})
      ),
      React.DOM.span(
        {onClick:votes.up ? this.props.onClearVote : this.props.onUpvote,
        className:cx({
          "button commented_up": true,
          "commented_up--shown shown": !!votes.upCount,
          "commented_up--active active": votes.up
        })}, 
        React.DOM.span( {className:"count"}, votes.upCount),
        React.DOM.i( {className:"fa fa-thumbs-o-up"})
      ),
      !this.props.isReply && React.DOM.span( {onClick:this.props.onReply, className:"commented_reply"}, "reply")
    );
  },

  editButtons: function () {
    return React.DOM.div( {className:"commented_buttons"}, 
      React.DOM.span( {onClick:this.doneEditing, className:"commented_done-edit button"}, 
        this.props.creating ? 'post' : 'save'
      ),
      React.DOM.span( {onClick:this.cancelEdit, className:"commented_remove button"}, 
        "cancel"
      )
    )
  },

  replyLogin: function () {
    if (this.props.isReply) return false
    return React.DOM.div( {className:"commented_buttons"}, 
      ReplyLogin(
        {db:this.props.db,
        auth:this.props.db.options.auth,
        onCancel:this.props.cancelReply,
        onReply:this.props.onReply})
    )
  },

  buttons: function (votes) {
    if (!this.props.userid) {
      return this.replyLogin()
    }
    if (!this.props.canEdit) {
      return this.voteButtons(votes)
    }
    if (this.props.editing) {
      return this.editButtons()
    }
    return React.DOM.div( {className:"commented_buttons"}, 
      React.DOM.span( {onClick:this.props.onEdit, className:"commented_edit button"}, 
        React.DOM.i( {className:"fa fa-pencil"})
      ),
      React.DOM.span( {onClick:this.props.onRemove, className:"commented_remove button"}, 
        React.DOM.i( {className:"fa fa-times"})
      ),
      !this.props.isReply && React.DOM.span( {onClick:this.props.onReply, className:"commented_reply"}, "reply")
    );
  },

  body: function () {
    if (!this.props.editing) {
      return format(this.props.data.text, "text")
    }
    return AutoTextarea(
      {placeholder:"Type your comment here",
      onChange:this.onChange,
      value:this.state.text})
  },

  render: function () {
    var comment = this.props.data
      , cls = "commented_comment"
    if (this.props.editing) {
      cls += ' commented_comment--editing'
    }
    if (this.props.canEdit) {
      cls += ' commented_comment--mine'
    }
    if (this.props.isReply) {
      cls += ' commented_comment--reply'
    }
    if (this.props.hasReplies) {
      cls += ' commented_comment--has-replies'
    }

    var votes = this.getVotes()
    if (votes.flagCount > 2 && this.props.userid !== this.props.data.userid) {
      return React.DOM.div( {className:cls + " commented_comment--flagged"}, 
        React.DOM.span( {className:"commented_pic fa-stack fa-lg"}, 
          React.DOM.i( {className:"fa fa-circle fa-stack-2x"}),
          React.DOM.i( {className:"fa fa-flag fa-stack-1x fa-inverse"})
        ),
        React.DOM.span( {className:"display-name"}, 
          "flagged comment hidden"
        )
      )
    }

    return React.DOM.div( {className:cls}, 
      React.DOM.img( {className:"commented_pic", src:comment.picture}),
      React.DOM.div( {className:"right"}, 
        this.buttons(votes),
        React.DOM.strong( {className:"display-name"}, comment.displayName),
        comment.created && // TODO have this time auto-update
          React.DOM.span( {className:"display-time"}, moment(comment.created).fromNow()),
        this.props.parentDeleted &&
          React.DOM.span( {className:"parent-deleted"}, "in reply to a deleted comment"),
        this.props.creating &&
          React.DOM.button( {className:"commented_logout", onClick:this.props.onLogout}, "logout"),
        this.body()
      )
    );
  }
});

module.exports = CommentDisplay

},{"./auto-textarea.jsx":3,"./format":10,"./reply-login.jsx":15}],6:[function(require,module,exports){
/** @jsx React.DOM */
var CommentDisplay = require('./comment-display.jsx')

var Comment = React.createClass({displayName: 'Comment',
  propTypes: {
    data: React.PropTypes.object.isRequired,
    canEdit: React.PropTypes.bool.isRequired,
    userid: React.PropTypes.string.isRequired,
    db: React.PropTypes.object,
  },

  getInitialState: function () {
    return {
      editing: false,
      replying: false,
    }
  },

  onRemove: function () {
    this.props.db.removeComment(this.props.data._id)
  },

  onEdit: function () {
    this.setState({editing: true})
  },

  onReply: function () {
    if (this.props.isReply) return
    this.setState({editing: false, replying: true});
  },

  onClearVote: function () {
    this.props.db.clearVote(this.props.data._id, this.props.userid)
  },

  onDownvote: function (erase) {
    this.props.db.downVote(this.props.data._id, this.props.userid)
  },

  onUpvote: function () {
    this.props.db.upVote(this.props.data._id, this.props.userid)
  },

  onFlag: function (flag) {
    this.props.db.flag(this.props.data._id, this.props.userid, flag)
  },

  cancelEdit: function () {
    this.setState({editing: false})
  },

  doneEditing: function (text) {
    if (!this.state.editing) return
    if (!text) return
    this.props.db.editComment(this.props.data._id, text)
    this.setState({editing: false})
  },

  doneReplying: function (text) {
    if (!this.state.replying) return
    if (!text) return
    this.props.db.addComment(text, "reply:" + this.props.data._id, '')
    this.setState({replying: false})
  },

  cancelReply: function () {
    this.setState({replying: false})
  },

  renderReplies: function () {
    var replies = this.props.replies
    if (!replies.length && !this.state.replying) {
      return false
    }
    var user = this.props.user
    return React.DOM.div( {className:"commented_replies"}, 
      replies.map(function (comment) {
        return Comment({
          key: comment._id,
          isReply: true,
          replies: [],
          canEdit: user && user.uid == comment.userid,
          canVote: !!user,
          userid: user && user.uid,
          data: comment,
          user: user,
          db: this.props.db,
        })
      }.bind(this)),
      this.state.replying && user && CommentDisplay({
        editing: true,
        canEdit: true,
        canVote: false,
        data: {
          picture: this.props.user.picture,
          displayName: this.props.user.displayName,
          text: ''
        },
        onLogout: this.onLogout,
        userid: this.props.userid,
        isReply: true,
        creating: true,

        cancelEdit: this.cancelReply,
        doneEditing: this.doneReplying,
        onRemove: this.cancelReply
      })
    )
  },

  onLogout: function () {
    this.setState({replying: false, editing: false})
    this.props.db.logout()
  },

  render: function () {
    return React.DOM.div( {className:"commented_one"}, 
      CommentDisplay({
        editing: this.state.editing,
        canEdit: this.props.canEdit,
        canVote: this.props.canVote,
        data: this.props.data,
        db: this.props.db,
        isReply: this.props.isReply,
        hasReplies: (this.props.userid && this.state.replying) || this.props.replies && this.props.replies.length,
        userid: this.props.userid,
        parentDeleted: this.props.parentDeleted,

        onEdit: this.onEdit,
        onFlag: this.onFlag,
        onReply: !this.props.isReply && this.onReply,
        cancelReply: this.cancelReply,
        onLogout: this.onLogout,
        onRemove: this.onRemove,
        onUpvote: this.onUpvote,
        onDownvote: this.onDownvote,
        onClearVote: this.onClearVote,
        doneEditing: this.doneEditing,
        cancelEdit: this.cancelEdit,
      }),
      this.renderReplies()
    )
  }
});

module.exports = Comment;

},{"./comment-display.jsx":5}],7:[function(require,module,exports){
/** @jsx React.DOM */
var AutoTextarea = require('./auto-textarea.jsx')
var CommentDisplay = require('./comment-display.jsx')

var CreateComment = React.createClass({displayName: 'CreateComment',
  propTypes: {
    onHide: React.PropTypes.func.isRequired,
    target: React.PropTypes.string.isRequired,
    db: React.PropTypes.object.isRequired,
    user: React.PropTypes.object.isRequired
  },
  getInitialState: function () {
    return {
      text: ''
    }
  },

  _onSubmit: function (text) {
    if (!text) return
    this.props.db.addComment(text, this.props.target, false)
    this.props.onHide()
  },

  render: function () {
    return CommentDisplay({
      canEdit: true,
      editing: true,
      creating: true,
      data: {
        picture: this.props.user.picture,
        displayName: this.props.user.displayName,
        text: '',
      },
      userid: this.props.user.uid,

      onLogout: this.props.db.logout.bind(this.props.db),
      cancelEdit: this.props.onHide,
      doneEditing: this._onSubmit,
      onRemove: this.props.onHide
    })
  }
});

module.exports = CreateComment


},{"./auto-textarea.jsx":3,"./comment-display.jsx":5}],8:[function(require,module,exports){

module.exports = DBFirebase

function DBFirebase(options) {
  this.db = new Firebase('https://' + options.firebase + '.firebaseio.com/comments/' + options.slug);
  var onValue
  this.db.on('value', onValue = function () {
    this.db.off('value', onValue)
    this.loaded = true
  }.bind(this));
  this.user = null
  this.options = options

  this._auth = new FirebaseSimpleLogin(this.db, this._onLogin.bind(this));
  this.liHanders = []
}

DBFirebase.prototype = {

  // normal edits

  addComment: function (text, target, quote) {
    if (!this.user) {
      return console.error("Not logged in");
    }
    this.db.push({
      created: Date.now(),
      displayName: this.user.displayName,
      picture: this.user.picture,
      userid: this.user.uid,
      text: text,
      target: target,
      quote: quote
    })
  },

  editComment: function (id, text) {
    if (!this.user) {
      return console.error("Not logged in");
    }
    this.db.child(id).update({text: text})
  },

  removeComment: function (id) {
    if (!this.user) {
      return console.error("Not logged in");
    }
    this.db.child(id).remove()
  },

  // voting!!

  flag: function (id, uid, flag) {
    this.db.child(id).child('flags').child(uid).set(flag)
  },

  downVote: function (id, uid) {
    this.db.child(id).child('votes').child(uid).set(false)
  },

  clearVote: function (id, uid) {
    this.db.child(id).child('votes').child(uid).remove()
  },

  upVote: function (id, uid) {
    this.db.child(id).child('votes').child(uid).set(true)
  },

  login: function (type) {
    this._auth.login(type, {
      rememberMe: true
    })
  },

  _onLogin: function (err, user) {
    if (err || !user) {
      return this.fireLoggedin(null)
    }
    user.picture = (user.thirdPartyUserData.profile_image_url || // twitter
                    user.thirdPartyUserData.picture ||  // google
                    user.thirdPartyUserData.avatar_url) // github
    // facebook
    if (user.picture && user.picture.data) {
      user.picture = user.picture.data.url
    }
    this.user = user
    this.fireLoggedin(user)
  },

  fireLoggedin: function (user) {
    this.liHanders.forEach(function (fn) {
      fn(user)
    })
  },

  logout: function () {
    this._auth.logout()
  },

  onLogin: function (cb) {
    this.liHanders.push(cb)
  },

  offLogin: function (cb) {
    var i = this.liHanders.indexOf(cb)
    if (i === -1) return
    this.liHanders.splice(i, 1)
  },

  onceLoaded: function (done) {
    var onValue
    this.db.on('value', onValue = function () {
      done()
      this.db.off('value', onValue)
    }.bind(this))
  },

  // register event listeners
  onAdd: function (cb) {
    this.db.on('child_added', function (snapshot) {
      var val = snapshot.val()
      val._id = snapshot.name()
      cb(val);
    });
  },
  onChange: function (cb) {
    this.db.on('child_changed', function (snapshot) {
      var val = snapshot.val()
      val._id = snapshot.name()
      cb(val)
    });
  },
  onRemove: function (cb) {
    this.db.on('child_removed', function (snapshot) {
      cb(snapshot.name());
    });
  },
}

},{}],9:[function(require,module,exports){

var DBFirebase = require('./db-firebase');
// var DBHoodie = require('./db-hoodie');

module.exports = function (options) {
  switch (options.type) {
    /* Not ready yet
    case "hoodie":
      return new DBHoodie(options);*/
    case "firebase":
      return new DBFirebase(options);
    default:
      console.error("Invalid backend specified", options.type, options);
  }
}


},{"./db-firebase":8}],10:[function(require,module,exports){

if (window.marked) {
  marked.setOptions({
    gfm: true,
    tables: true,
    breaks: true,
    pedantic: false,
    sanitize: false,
    smartLists: true,
    smartypants: true,
  })
  module.exports = function (text, cls) {
    return React.DOM.div({
      className: cls,
      dangerouslySetInnerHTML: {
        __html: marked(text)
      }
    });
  }
} else {
  module.exports = function (x, cls) {
    return React.DOM.div({className: cls}, x)
  }
}


},{}],11:[function(require,module,exports){

var cleanSlug = require('./clean-slug.js')
  , getDb = require('./db')

  // , InlineComments = require('./inline-comments.jsx')
  , MainComments = require('./main-comments.jsx')

module.exports = function (options) {
  options.slug = cleanSlug(options.slug)

  var db = window.db = getDb(options)
  if (!db) return console.error('Failed to initialize db')

  var nodes
  if (options.inline && false) {
    var body = document.querySelector(options.inline)
    body.classList.add('commented_inline-body')
    nodes = body.querySelectorAll(options.inline + ' p')
    nodes.forEach(function (node) {
      React.renderComponent(InlineComments({
        auth: auth,
        db: db
      }), node);
    });
  }

  React.renderComponent(MainComments({
    auth: options.auth,
    db: db
  }), options.main);

  // create the main component, then create a sidebar component
}


},{"./clean-slug.js":4,"./db":9,"./main-comments.jsx":13}],12:[function(require,module,exports){
/** @jsx React.DOM */
var ICONS = {
  facebook: 'facebook',
  twitter: 'twitter',
  google: 'google',
  github: 'github'
}

var Login = React.createClass({displayName: 'Login',
  propTypes: {
    db: React.PropTypes.object.isRequired,
    auth: React.PropTypes.array.isRequired,
    onLogin: React.PropTypes.func.isRequired,
    onCancel: React.PropTypes.func.isRequired
  },

  getInitialState: function () {
    return {
      loading: false
    }
  },

  componentDidMount: function () {
    this.props.db.onLogin(this._onLogin)
  },
  componentWillUnmount: function () {
    this.props.db.offLogin(this._onLogin)
  },

  _onLogin: function () {
    this.setState({loading: false})
  },

  onClick: function (type) {
    this.setState({loading: type})
    this.props.db.login(type)
  },

  render: function () {
    if (this.state.loading) {
      return React.DOM.div( {className:"commented_login--loading commented_login"}, 
        "Connecting to ", this.state.loading,
        React.DOM.i( {className:"fa fa-spin fa-spinner"})
      )
    }

    return React.DOM.div( {className:"commented_login"}, 
      this.props.auth.map(function (type) {
        var icon = ICONS[type]
          , cls = "commented_login-type"
        cls += ' commented_login-type--' + type
        return React.DOM.button( {key:type, className:cls, onClick:this.onClick.bind(this, type)}, 
          React.DOM.span( {className:"commented_pic fa-stack fa-lg"}, 
            React.DOM.i( {className:"fa fa-circle fa-stack-2x"}),
            React.DOM.i( {className:"fa fa-" + icon + " fa-stack-1x fa-inverse"})
          )
        );
      }.bind(this)),
      React.DOM.button( {className:"commented_login-type commente_login-type--cancel",
        onClick:this.props.onCancel}, "×"
      )
    );
  }
});

module.exports = Login

},{}],13:[function(require,module,exports){
/** @jsx React.DOM */
var mixing = require('./mixin')
  , Comment = require('./comment.jsx')
  , ShowAller = require('./show-aller.jsx')
  , AddComment = require('./add-comment.jsx')

var MainComments = React.createClass({displayName: 'MainComments',
  mixins: [mixing],
  propTypes: {
    db: React.PropTypes.object.isRequired,
    auth: React.PropTypes.array.isRequired
  },
  getInitialState: function () {
    return {
      showAll: false,
      loading: !this.props.db.loaded
    }
  },

  componentDidMount: function () {
    this.props.db.onLogin(this._onLogin)
    if (!this.props.db.loaded) {
      this.props.db.onceLoaded(this._onLoaded)
    }
  },

  componentWillUnmount: function () {
    this.props.db.offLogin(this._onLogin)
  },

  _onLoaded: function () {
    this.setState({loading: false})
  },

  _onChangeShow: function (which) {
    this.setState({
      showAll: which
    })
  },

  organizeComments: function () {
    var ids = Object.keys(this.state.comments)
      , comments = this.state.comments
      , showAll = this.state.showAll
      , inlines = 0
      , replies = []
      , map = {}
      , list = []

    ids.forEach(function (id) {
      if (!comments[id]) return
      var item = {
        comment: comments[id],
        replies: []
      }
      var target = comments[id].target
      map[id] = item
      if (target === 'main') {
        list.push(item)
      } else if (target.indexOf('inline:') === 0) {
        inlines += 1
        if (showAll) list.push(item)
      } else if (target.indexOf('reply:') === 0) {
        replies.push(comments[id])
      }
    })

    replies.forEach(function (comment) {
      var parent = comment.target.slice('reply:'.length)
      if (!map[parent]) {
        // this is in reply to a comment that was deleted...
        list.push({comment: comment, parentDeleted: true, replies: []})
        return
      }
      map[parent].replies.push(comment)
    });

    return {
      list: list,
      inlines: inlines
    }
  },

  _onLogin: function (user) {
    this.setState({user: user})
  },

  renderComments: function () {
    if (!Object.keys(this.state.comments).length) {
      if (this.state.loading) {
        return React.DOM.span(null, React.DOM.i( {className:"fa fa-spin fa-spinner"}), " Loading...")
      }
      return null
    }

    var organized = this.organizeComments()
    var user = this.state.user
    var db = this.props.db

    var comments = organized.list.map(function (item) {
      return Comment({
        key: item.comment._id,
        replies: item.replies,
        parentDeleted: item.parentDeleted,
        canEdit: user && user.uid == item.comment.userid,
        canVote: !!user,
        userid: user && user.uid,
        data: item.comment,
        user: user,
        db: db,
      })
    }.bind(this))

    return React.DOM.div( {className:"commented_comments"}, 
      organized.inlines ? ShowAller({
        count: organized.inlines,
        showAll: this.state.showAll,
        onChange: this._onChangeShow
      }) : false,
      comments
    );
  },

  render: function () {
    return React.DOM.div( {className:"commented_main"}, 
      this.renderComments(),
      React.DOM.div( {className:"commented_add"}, 
        AddComment(
          {target:"main",
          user:this.state.user,
          auth:this.props.auth,
          db:this.props.db})
      ),
      React.DOM.div( {className:"commented_attribution"}, 
        "Comments powered by ", React.DOM.a( {target:"_blank", href:"http://commented.github.io"}, "//commented")
      )
    );
  }
});

module.exports = MainComments;

},{"./add-comment.jsx":2,"./comment.jsx":6,"./mixin":14,"./show-aller.jsx":16}],14:[function(require,module,exports){

var up = React.addons.update

module.exports = {
  propTypes: {
    db: React.PropTypes.object.isRequired,
    auth: React.PropTypes.array.isRequired
  },

  getInitialState: function () {
    return {
      comments: {},
      user: null
    }
  },

  componentDidMount: function () {
    this.props.db.onAdd(this._onAdded);
    this.props.db.onRemove(this._onRemoved);
    this.props.db.onChange(this._onChanged);
    this.setState({user: this.props.db.user});
  },

  // firebase callbacks
  _onAdded: function (comment) {
    if (this.props.target && comment.target !== this.props.target) {
      return
    }
    var update = {}
    update[comment._id] = {$set: comment}
    this.setState({
        comments: up(this.state.comments, update)
    })
  },

  _onChanged: function (comment) {
    var update = {}
    update[comment._id] = {$set: comment}
    this.setState({
        comments: up(this.state.comments, update)
    })
  },

  _onRemoved: function (id) {
    var update = {}
    update[id] = {$set: null}
    this.setState({
        comments: up(this.state.comments, update)
    })
  },
}

},{}],15:[function(require,module,exports){
/** @jsx React.DOM */
var Login = require('./login.jsx')

var ReplyLogin = React.createClass({displayName: 'ReplyLogin',
  propTypes: {
    db: React.PropTypes.object.isRequired,
    auth: React.PropTypes.array.isRequired,
    onCancel: React.PropTypes.func,
    onReply: React.PropTypes.func
  },
  getInitialState: function () {
    return {
      open: false
    }
  },
  onOpen: function () {
    this.props.onReply()
    this.setState({open: true})
  },
  onCancel: function () {
    this.props.onCancel()
    this.setState({open: false})
  },
  render: function () {
    return React.DOM.span( {className:"commented_reply-login"}, 
      this.state.open ?
        Login(
          {db:this.props.db,
          auth:this.props.auth,
          onLogin:this.props.onReply,
          onCancel:this.onCancel}
        ) :
        React.DOM.span( {onClick:this.onOpen, className:"commented_reply"}, "reply")
      
    )
  },
})

module.exports = ReplyLogin

},{"./login.jsx":12}],16:[function(require,module,exports){
/** @jsx React.DOM */
var ShowAller = React.createClass({displayName: 'ShowAller',
  propTypes: {
    skipped: React.PropTypes.number
  },
  render: function () {
    var show = this.props.showAll
    return React.DOM.div( {className:"commented_show-aller"}, 
      React.DOM.button(
          {className:"commented_show-aller_btn",
          onClick:this.props.onChange.bind(null, !show)}, 
        show ? 'Hide' : 'Show', " ", this.props.count, " side comments"
      )
    );
  }
});

module.exports = ShowAller


},{}]},{},[1])
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGVkLmpzIiwic291cmNlcyI6WyIvdXNyL2xvY2FsL2xpYi9ub2RlX21vZHVsZXMvd2F0Y2hpZnkvbm9kZV9tb2R1bGVzL2Jyb3dzZXJpZnkvbm9kZV9tb2R1bGVzL2Jyb3dzZXItcGFjay9fcHJlbHVkZS5qcyIsIi9Vc2Vycy9raGFuaW50ZXJuMS9jbG9uZS9jb21tZW50ZWQvaW5kZXguanMiLCIvVXNlcnMva2hhbmludGVybjEvY2xvbmUvY29tbWVudGVkL2xpYi9hZGQtY29tbWVudC5qc3giLCIvVXNlcnMva2hhbmludGVybjEvY2xvbmUvY29tbWVudGVkL2xpYi9hdXRvLXRleHRhcmVhLmpzeCIsIi9Vc2Vycy9raGFuaW50ZXJuMS9jbG9uZS9jb21tZW50ZWQvbGliL2NsZWFuLXNsdWcuanMiLCIvVXNlcnMva2hhbmludGVybjEvY2xvbmUvY29tbWVudGVkL2xpYi9jb21tZW50LWRpc3BsYXkuanN4IiwiL1VzZXJzL2toYW5pbnRlcm4xL2Nsb25lL2NvbW1lbnRlZC9saWIvY29tbWVudC5qc3giLCIvVXNlcnMva2hhbmludGVybjEvY2xvbmUvY29tbWVudGVkL2xpYi9jcmVhdGUtY29tbWVudC5qc3giLCIvVXNlcnMva2hhbmludGVybjEvY2xvbmUvY29tbWVudGVkL2xpYi9kYi1maXJlYmFzZS5qcyIsIi9Vc2Vycy9raGFuaW50ZXJuMS9jbG9uZS9jb21tZW50ZWQvbGliL2RiLmpzIiwiL1VzZXJzL2toYW5pbnRlcm4xL2Nsb25lL2NvbW1lbnRlZC9saWIvZm9ybWF0LmpzIiwiL1VzZXJzL2toYW5pbnRlcm4xL2Nsb25lL2NvbW1lbnRlZC9saWIvaW5kZXguanMiLCIvVXNlcnMva2hhbmludGVybjEvY2xvbmUvY29tbWVudGVkL2xpYi9sb2dpbi5qc3giLCIvVXNlcnMva2hhbmludGVybjEvY2xvbmUvY29tbWVudGVkL2xpYi9tYWluLWNvbW1lbnRzLmpzeCIsIi9Vc2Vycy9raGFuaW50ZXJuMS9jbG9uZS9jb21tZW50ZWQvbGliL21peGluLmpzIiwiL1VzZXJzL2toYW5pbnRlcm4xL2Nsb25lL2NvbW1lbnRlZC9saWIvcmVwbHktbG9naW4uanN4IiwiL1VzZXJzL2toYW5pbnRlcm4xL2Nsb25lL2NvbW1lbnRlZC9saWIvc2hvdy1hbGxlci5qc3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUNBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDMUJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUN0Q0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUMvQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDTkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNuTkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ2xKQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUM3Q0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDMUlBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDaEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDekJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDbENBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ2xFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUM3SUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDbkRBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3ZDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uIGUodCxuLHIpe2Z1bmN0aW9uIHMobyx1KXtpZighbltvXSl7aWYoIXRbb10pe3ZhciBhPXR5cGVvZiByZXF1aXJlPT1cImZ1bmN0aW9uXCImJnJlcXVpcmU7aWYoIXUmJmEpcmV0dXJuIGEobywhMCk7aWYoaSlyZXR1cm4gaShvLCEwKTt0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgZmluZCBtb2R1bGUgJ1wiK28rXCInXCIpfXZhciBmPW5bb109e2V4cG9ydHM6e319O3Rbb11bMF0uY2FsbChmLmV4cG9ydHMsZnVuY3Rpb24oZSl7dmFyIG49dFtvXVsxXVtlXTtyZXR1cm4gcyhuP246ZSl9LGYsZi5leHBvcnRzLGUsdCxuLHIpfXJldHVybiBuW29dLmV4cG9ydHN9dmFyIGk9dHlwZW9mIHJlcXVpcmU9PVwiZnVuY3Rpb25cIiYmcmVxdWlyZTtmb3IodmFyIG89MDtvPHIubGVuZ3RoO28rKylzKHJbb10pO3JldHVybiBzfSkiLCJcbnZhciBDb21tZW50ZWQgPSByZXF1aXJlKCcuL2xpYicpXG5cbmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBmdW5jdGlvbiAoKSB7XG4gIHZhciBub2RlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NvbW1lbnRlZC1tYWluJyk7XG4gIGlmICghbm9kZSkge1xuICAgIGNvbnNvbGUuZXJyb3IoJyNjb21tZW50ZWQgbm9kZSBub3QgZm91bmQnKTtcbiAgICByZXR1cm47XG4gIH1cbiAgdmFyIG9wdGlvbnMgPSB7XG4gICAgZmlyZWJhc2U6IG5vZGUuZ2V0QXR0cmlidXRlKCdkYXRhLWZpcmViYXNlJyksXG4gICAgdHlwZTogJ2ZpcmViYXNlJyxcbiAgICBhdXRoOiBub2RlLmdldEF0dHJpYnV0ZSgnZGF0YS1hdXRoJykuc3BsaXQoJyAnKSxcbiAgICBzbHVnOiBub2RlLmdldEF0dHJpYnV0ZSgnZGF0YS1zbHVnJykgfHwgd2luZG93LmxvY2F0aW9uICsgJycsXG4gICAgaW5saW5lOiBub2RlLmdldEF0dHJpYnV0ZSgnZGF0YS1pbmxpbmUnKSxcbiAgICBtYWluOiBub2RlXG4gIH1cblxuICAvLyBmaXJlYmFzZSBpcyBjdXJyZW50bHkgdGhlIG9ubHkgc3VwcG9ydGVkIGhvc3RcbiAgaWYgKCFvcHRpb25zLmZpcmViYXNlKSB7XG4gICAgY29uc29sZS5lcnJvcignSW52YWxpZCBjb25maWd1cmF0aW9uISBkYXRhLWZpcmViYXNlIG11c3QgYmUgc3BlY2lmaWVkJylcbiAgICByZXR1cm47XG4gIH1cbiAgQ29tbWVudGVkKG9wdGlvbnMpO1xufSk7XG5cbiIsIi8qKiBAanN4IFJlYWN0LkRPTSAqL1xudmFyIExvZ2luID0gcmVxdWlyZSgnLi9sb2dpbi5qc3gnKVxuICAsIENyZWF0ZUNvbW1lbnQgPSByZXF1aXJlKCcuL2NyZWF0ZS1jb21tZW50LmpzeCcpXG5cbnZhciBBZGRDb21tZW50ID0gUmVhY3QuY3JlYXRlQ2xhc3Moe2Rpc3BsYXlOYW1lOiAnQWRkQ29tbWVudCcsXG4gIHByb3BUeXBlczoge1xuICAgIHVzZXI6IFJlYWN0LlByb3BUeXBlcy5vYmplY3QuaXNSZXF1aXJlZCxcbiAgICBhdXRvQWRkOiBSZWFjdC5Qcm9wVHlwZXMuYm9vbCxcbiAgfSxcbiAgZ2V0SW5pdGlhbFN0YXRlOiBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGFkZGluZzogZmFsc2VcbiAgICB9XG4gIH0sXG4gIG9uU2hvdzogZnVuY3Rpb24gKCkge1xuICAgIHRoaXMuc2V0U3RhdGUoe2FkZGluZzogdHJ1ZX0pO1xuICB9LFxuICBvbkhpZGU6IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLnNldFN0YXRlKHthZGRpbmc6IGZhbHNlfSk7XG4gIH0sXG4gIHJlbmRlcjogZnVuY3Rpb24gKCkge1xuICAgIGlmICghdGhpcy5zdGF0ZS5hZGRpbmcgJiYgIXRoaXMucHJvcHMuYXV0b0FkZCkge1xuICAgICAgcmV0dXJuIFJlYWN0LkRPTS5kaXYoIHtjbGFzc05hbWU6XCJhZGQtY29tbWVudFwiLCBvbkNsaWNrOnRoaXMub25TaG93fSwgXG4gICAgICAgIFwiQWRkIGEgY29tbWVudFwiXG4gICAgICApXG4gICAgfVxuICAgIGlmICghdGhpcy5wcm9wcy51c2VyKSB7XG4gICAgICByZXR1cm4gTG9naW4oIHtkYjp0aGlzLnByb3BzLmRiLCBhdXRoOnRoaXMucHJvcHMuYXV0aCwgb25DYW5jZWw6dGhpcy5vbkhpZGV9KVxuICAgIH1cbiAgICByZXR1cm4gQ3JlYXRlQ29tbWVudChcbiAgICAgIHtvbkhpZGU6dGhpcy5vbkhpZGUsXG4gICAgICB0YXJnZXQ6dGhpcy5wcm9wcy50YXJnZXQsXG4gICAgICBkYjp0aGlzLnByb3BzLmRiLFxuICAgICAgdXNlcjp0aGlzLnByb3BzLnVzZXJ9KVxuICB9XG59KTtcblxubW9kdWxlLmV4cG9ydHMgPSBBZGRDb21tZW50XG4iLCIvKiogQGpzeCBSZWFjdC5ET00gKi9cbnZhciBBdXRvVGV4dGFyZWEgPSBSZWFjdC5jcmVhdGVDbGFzcyh7ZGlzcGxheU5hbWU6ICdBdXRvVGV4dGFyZWEnLFxuICBjb21wb25lbnREaWRNb3VudDogZnVuY3Rpb24gKCkge1xuICAgIHZhciBub2RlID0gdGhpcy5nZXRET01Ob2RlKClcbiAgICBub2RlLnN0eWxlLmhlaWdodCA9ICdhdXRvJ1xuICAgIG5vZGUuc3R5bGUuaGVpZ2h0ID0gbm9kZS5zY3JvbGxIZWlnaHQgKyAncHgnXG4gICAgbm9kZS5zdHlsZS5zY3JvbGxUb3AgPSBub2RlLnNjcm9sbEhlaWdodFxuICAgIG5vZGUuZm9jdXMoKVxuICAgIG5vZGUuc2VsZWN0aW9uU3RhcnQgPSBub2RlLnNlbGVjdGlvbkVuZCA9IG5vZGUudmFsdWUubGVuZ3RoXG4gIH0sXG5cbiAgcmVuZGVyOiBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIHN0eWxlXG4gICAgICAsIG5vZGVcblxuICAgIGlmICh0aGlzLmlzTW91bnRlZCgpKSB7XG4gICAgICBub2RlID0gdGhpcy5nZXRET01Ob2RlKClcbiAgICAgIG5vZGUuc3R5bGUuaGVpZ2h0ID0gJ2F1dG8nXG4gICAgICBub2RlLnN0eWxlLmhlaWdodCA9IG5vZGUuc2Nyb2xsSGVpZ2h0ICsgJ3B4J1xuICAgICAgc3R5bGUgPSB7XG4gICAgICAgIGhlaWdodDogbm9kZS5zY3JvbGxIZWlnaHQgKyAncHgnLFxuICAgICAgICBzY3JvbGxUb3A6IG5vZGUuc2Nyb2xsSGVpZ2h0XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnRyYW5zZmVyUHJvcHNUbyhcbiAgICAgIFJlYWN0LkRPTS50ZXh0YXJlYSgge3N0eWxlOnN0eWxlLCBjbGFzc05hbWU6XCJhdXRvLXRleHRhcmVhXCJ9KVxuICAgIClcbiAgfVxufSk7XG5cbm1vZHVsZS5leHBvcnRzID0gQXV0b1RleHRhcmVhXG4iLCJcbm1vZHVsZS5leHBvcnRzID0gY2xlYW5TbHVnXG5cbmZ1bmN0aW9uIGNsZWFuU2x1ZyhzbHVnKSB7XG4gIHJldHVybiBzbHVnLnJlcGxhY2UoL1teYS16QS1aMC05XS9nbSwgJy0nKVxufVxuIiwiLyoqIEBqc3ggUmVhY3QuRE9NICovXG52YXIgZm9ybWF0ID0gcmVxdWlyZSgnLi9mb3JtYXQnKVxuICAsIEF1dG9UZXh0YXJlYSA9IHJlcXVpcmUoJy4vYXV0by10ZXh0YXJlYS5qc3gnKVxuICAsIFJlcGx5TG9naW4gPSByZXF1aXJlKCcuL3JlcGx5LWxvZ2luLmpzeCcpXG4gICwgY3ggPSBSZWFjdC5hZGRvbnMuY2xhc3NTZXRcblxudmFyIENvbW1lbnREaXNwbGF5ID0gUmVhY3QuY3JlYXRlQ2xhc3Moe2Rpc3BsYXlOYW1lOiAnQ29tbWVudERpc3BsYXknLFxuICBwcm9wVHlwZXM6IHtcbiAgICBlZGl0aW5nOiBSZWFjdC5Qcm9wVHlwZXMuYm9vbC5pc1JlcXVpcmVkLFxuICAgIGNhbkVkaXQ6IFJlYWN0LlByb3BUeXBlcy5ib29sLmlzUmVxdWlyZWQsXG4gICAgZGF0YTogUmVhY3QuUHJvcFR5cGVzLm9iamVjdC5pc1JlcXVpcmVkLFxuICAgIGlzUmVwbHk6IFJlYWN0LlByb3BUeXBlcy5ib29sLFxuXG4gICAgb25FZGl0OiBSZWFjdC5Qcm9wVHlwZXMuZnVuYyxcbiAgICBkb25lRWRpdGluZzogUmVhY3QuUHJvcFR5cGVzLmZ1bmMsXG4gICAgb25SZW1vdmU6IFJlYWN0LlByb3BUeXBlcy5mdW5jLFxuXG4gICAgb25SZXBseTogUmVhY3QuUHJvcFR5cGVzLmZ1bmMsXG4gICAgb25VcHZvdGU6IFJlYWN0LlByb3BUeXBlcy5mdW5jLFxuICAgIG9uRG93bnZvdGU6IFJlYWN0LlByb3BUeXBlcy5mdW5jLFxuICAgIG9uQ2xlYXJWb3RlOiBSZWFjdC5Qcm9wVHlwZXMuZnVuYyxcbiAgICBvbkZsYWc6IFJlYWN0LlByb3BUeXBlcy5mdW5jLFxuICB9LFxuXG4gIGdldEluaXRpYWxTdGF0ZTogZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiB7XG4gICAgICB0ZXh0OiB0aGlzLnByb3BzLmRhdGEudGV4dCxcbiAgICB9XG4gIH0sXG5cbiAgY2FuY2VsRWRpdDogZnVuY3Rpb24gKCkge1xuICAgIHRoaXMuc2V0U3RhdGUoe3RleHQ6IHRoaXMucHJvcHMuZGF0YS50ZXh0fSlcbiAgICB0aGlzLnByb3BzLmNhbmNlbEVkaXQoKVxuICB9LFxuXG4gIGRvbmVFZGl0aW5nOiBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5wcm9wcy5kb25lRWRpdGluZyh0aGlzLnN0YXRlLnRleHQpXG4gIH0sXG5cbiAgb25DaGFuZ2U6IGZ1bmN0aW9uIChlKSB7XG4gICAgdGhpcy5zZXRTdGF0ZSh7dGV4dDogZS50YXJnZXQudmFsdWV9KTtcbiAgfSxcblxuICBnZXRWb3RlczogZnVuY3Rpb24gKCkge1xuICAgIHZhciB2b3RlcyA9IHtcbiAgICAgIHVwOiBmYWxzZSxcbiAgICAgIHVwQ291bnQ6IDAsXG4gICAgICBkb3duOiBmYWxzZSxcbiAgICAgIGRvd25Db3VudDogMCxcbiAgICAgIGZsYWdnZWQ6IHRoaXMucHJvcHMuZGF0YS5mbGFncyAmJiB0aGlzLnByb3BzLmRhdGEuZmxhZ3NbdGhpcy5wcm9wcy51c2VyaWRdLFxuICAgICAgZmxhZ0NvdW50OiAwXG4gICAgfVxuXG4gICAgc3dpdGNoICh0aGlzLnByb3BzLmRhdGEudm90ZXMgJiYgdGhpcy5wcm9wcy5kYXRhLnZvdGVzW3RoaXMucHJvcHMudXNlcmlkXSkge1xuICAgICAgY2FzZSB0cnVlOlxuICAgICAgICB2b3Rlcy51cCA9IHRydWU7IGJyZWFrO1xuICAgICAgY2FzZSBmYWxzZTpcbiAgICAgICAgdm90ZXMuZG93biA9IHRydWU7IGJyZWFrO1xuICAgICAgZGVmYXVsdDogYnJlYWs7XG4gICAgfVxuICAgIGZvciAodmFyIGlkIGluIHRoaXMucHJvcHMuZGF0YS52b3Rlcykge1xuICAgICAgaWYgKHRoaXMucHJvcHMuZGF0YS52b3Rlc1tpZF0pIHtcbiAgICAgICAgdm90ZXMudXBDb3VudCArPSAxXG4gICAgICB9IGVsc2Uge1xuICAgICAgICB2b3Rlcy5kb3duQ291bnQgKz0gMVxuICAgICAgfVxuICAgIH1cbiAgICBmb3IgKHZhciBpZCBpbiB0aGlzLnByb3BzLmRhdGEuZmxhZ3MpIHtcbiAgICAgIGlmICh0aGlzLnByb3BzLmRhdGEuZmxhZ3NbaWRdKSB7XG4gICAgICAgIHZvdGVzLmZsYWdDb3VudCArPSAxXG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB2b3Rlc1xuICB9LFxuXG4gIHZvdGVCdXR0b25zOiBmdW5jdGlvbiAodm90ZXMpIHtcbiAgICBpZiAoIXRoaXMucHJvcHMuY2FuVm90ZSkgcmV0dXJuXG5cbiAgICByZXR1cm4gUmVhY3QuRE9NLmRpdigge2NsYXNzTmFtZTpcImNvbW1lbnRlZF9idXR0b25zXCJ9LCBcbiAgICAgIFJlYWN0LkRPTS5zcGFuKFxuICAgICAgICB7b25DbGljazp0aGlzLnByb3BzLm9uRmxhZy5iaW5kKG51bGwsICF2b3Rlcy5mbGFnZ2VkKSxcbiAgICAgICAgY2xhc3NOYW1lOmN4KHtcbiAgICAgICAgICBcImJ1dHRvbiBjb21tZW50ZWRfZmxhZ1wiOiB0cnVlLFxuICAgICAgICAgIFwiY29tbWVudGVkX2ZsYWctLWFjdGl2ZVwiOiB2b3Rlcy5mbGFnZ2VkXG4gICAgICAgIH0pfSwgXG4gICAgICAgIFJlYWN0LkRPTS5pKCB7Y2xhc3NOYW1lOlwiZmEgZmEtZmxhZ1wifSlcbiAgICAgICksXG4gICAgICBSZWFjdC5ET00uc3BhbihcbiAgICAgICAge29uQ2xpY2s6dm90ZXMuZG93biA/IHRoaXMucHJvcHMub25DbGVhclZvdGUgOiB0aGlzLnByb3BzLm9uRG93bnZvdGUsXG4gICAgICAgIGNsYXNzTmFtZTpjeCh7XG4gICAgICAgICAgXCJidXR0b24gY29tbWVudGVkX2Rvd25cIjogdHJ1ZSxcbiAgICAgICAgICBcImNvbW1lbnRlZF9kb3duLS1zaG93biBzaG93blwiOiAhIXZvdGVzLmRvd25Db3VudCxcbiAgICAgICAgICBcImNvbW1lbnRlZF9kb3duLS1hY3RpdmUgYWN0aXZlXCI6IHZvdGVzLmRvd25cbiAgICAgICAgfSl9LCBcbiAgICAgICAgUmVhY3QuRE9NLnNwYW4oIHtjbGFzc05hbWU6XCJjb3VudFwifSwgdm90ZXMuZG93bkNvdW50KSxcbiAgICAgICAgUmVhY3QuRE9NLmkoIHtjbGFzc05hbWU6XCJmYSBmYS10aHVtYnMtby1kb3duXCJ9KVxuICAgICAgKSxcbiAgICAgIFJlYWN0LkRPTS5zcGFuKFxuICAgICAgICB7b25DbGljazp2b3Rlcy51cCA/IHRoaXMucHJvcHMub25DbGVhclZvdGUgOiB0aGlzLnByb3BzLm9uVXB2b3RlLFxuICAgICAgICBjbGFzc05hbWU6Y3goe1xuICAgICAgICAgIFwiYnV0dG9uIGNvbW1lbnRlZF91cFwiOiB0cnVlLFxuICAgICAgICAgIFwiY29tbWVudGVkX3VwLS1zaG93biBzaG93blwiOiAhIXZvdGVzLnVwQ291bnQsXG4gICAgICAgICAgXCJjb21tZW50ZWRfdXAtLWFjdGl2ZSBhY3RpdmVcIjogdm90ZXMudXBcbiAgICAgICAgfSl9LCBcbiAgICAgICAgUmVhY3QuRE9NLnNwYW4oIHtjbGFzc05hbWU6XCJjb3VudFwifSwgdm90ZXMudXBDb3VudCksXG4gICAgICAgIFJlYWN0LkRPTS5pKCB7Y2xhc3NOYW1lOlwiZmEgZmEtdGh1bWJzLW8tdXBcIn0pXG4gICAgICApLFxuICAgICAgIXRoaXMucHJvcHMuaXNSZXBseSAmJiBSZWFjdC5ET00uc3Bhbigge29uQ2xpY2s6dGhpcy5wcm9wcy5vblJlcGx5LCBjbGFzc05hbWU6XCJjb21tZW50ZWRfcmVwbHlcIn0sIFwicmVwbHlcIilcbiAgICApO1xuICB9LFxuXG4gIGVkaXRCdXR0b25zOiBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIFJlYWN0LkRPTS5kaXYoIHtjbGFzc05hbWU6XCJjb21tZW50ZWRfYnV0dG9uc1wifSwgXG4gICAgICBSZWFjdC5ET00uc3Bhbigge29uQ2xpY2s6dGhpcy5kb25lRWRpdGluZywgY2xhc3NOYW1lOlwiY29tbWVudGVkX2RvbmUtZWRpdCBidXR0b25cIn0sIFxuICAgICAgICB0aGlzLnByb3BzLmNyZWF0aW5nID8gJ3Bvc3QnIDogJ3NhdmUnXG4gICAgICApLFxuICAgICAgUmVhY3QuRE9NLnNwYW4oIHtvbkNsaWNrOnRoaXMuY2FuY2VsRWRpdCwgY2xhc3NOYW1lOlwiY29tbWVudGVkX3JlbW92ZSBidXR0b25cIn0sIFxuICAgICAgICBcImNhbmNlbFwiXG4gICAgICApXG4gICAgKVxuICB9LFxuXG4gIHJlcGx5TG9naW46IGZ1bmN0aW9uICgpIHtcbiAgICBpZiAodGhpcy5wcm9wcy5pc1JlcGx5KSByZXR1cm4gZmFsc2VcbiAgICByZXR1cm4gUmVhY3QuRE9NLmRpdigge2NsYXNzTmFtZTpcImNvbW1lbnRlZF9idXR0b25zXCJ9LCBcbiAgICAgIFJlcGx5TG9naW4oXG4gICAgICAgIHtkYjp0aGlzLnByb3BzLmRiLFxuICAgICAgICBhdXRoOnRoaXMucHJvcHMuZGIub3B0aW9ucy5hdXRoLFxuICAgICAgICBvbkNhbmNlbDp0aGlzLnByb3BzLmNhbmNlbFJlcGx5LFxuICAgICAgICBvblJlcGx5OnRoaXMucHJvcHMub25SZXBseX0pXG4gICAgKVxuICB9LFxuXG4gIGJ1dHRvbnM6IGZ1bmN0aW9uICh2b3Rlcykge1xuICAgIGlmICghdGhpcy5wcm9wcy51c2VyaWQpIHtcbiAgICAgIHJldHVybiB0aGlzLnJlcGx5TG9naW4oKVxuICAgIH1cbiAgICBpZiAoIXRoaXMucHJvcHMuY2FuRWRpdCkge1xuICAgICAgcmV0dXJuIHRoaXMudm90ZUJ1dHRvbnModm90ZXMpXG4gICAgfVxuICAgIGlmICh0aGlzLnByb3BzLmVkaXRpbmcpIHtcbiAgICAgIHJldHVybiB0aGlzLmVkaXRCdXR0b25zKClcbiAgICB9XG4gICAgcmV0dXJuIFJlYWN0LkRPTS5kaXYoIHtjbGFzc05hbWU6XCJjb21tZW50ZWRfYnV0dG9uc1wifSwgXG4gICAgICBSZWFjdC5ET00uc3Bhbigge29uQ2xpY2s6dGhpcy5wcm9wcy5vbkVkaXQsIGNsYXNzTmFtZTpcImNvbW1lbnRlZF9lZGl0IGJ1dHRvblwifSwgXG4gICAgICAgIFJlYWN0LkRPTS5pKCB7Y2xhc3NOYW1lOlwiZmEgZmEtcGVuY2lsXCJ9KVxuICAgICAgKSxcbiAgICAgIFJlYWN0LkRPTS5zcGFuKCB7b25DbGljazp0aGlzLnByb3BzLm9uUmVtb3ZlLCBjbGFzc05hbWU6XCJjb21tZW50ZWRfcmVtb3ZlIGJ1dHRvblwifSwgXG4gICAgICAgIFJlYWN0LkRPTS5pKCB7Y2xhc3NOYW1lOlwiZmEgZmEtdGltZXNcIn0pXG4gICAgICApLFxuICAgICAgIXRoaXMucHJvcHMuaXNSZXBseSAmJiBSZWFjdC5ET00uc3Bhbigge29uQ2xpY2s6dGhpcy5wcm9wcy5vblJlcGx5LCBjbGFzc05hbWU6XCJjb21tZW50ZWRfcmVwbHlcIn0sIFwicmVwbHlcIilcbiAgICApO1xuICB9LFxuXG4gIGJvZHk6IGZ1bmN0aW9uICgpIHtcbiAgICBpZiAoIXRoaXMucHJvcHMuZWRpdGluZykge1xuICAgICAgcmV0dXJuIGZvcm1hdCh0aGlzLnByb3BzLmRhdGEudGV4dCwgXCJ0ZXh0XCIpXG4gICAgfVxuICAgIHJldHVybiBBdXRvVGV4dGFyZWEoXG4gICAgICB7cGxhY2Vob2xkZXI6XCJUeXBlIHlvdXIgY29tbWVudCBoZXJlXCIsXG4gICAgICBvbkNoYW5nZTp0aGlzLm9uQ2hhbmdlLFxuICAgICAgdmFsdWU6dGhpcy5zdGF0ZS50ZXh0fSlcbiAgfSxcblxuICByZW5kZXI6IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgY29tbWVudCA9IHRoaXMucHJvcHMuZGF0YVxuICAgICAgLCBjbHMgPSBcImNvbW1lbnRlZF9jb21tZW50XCJcbiAgICBpZiAodGhpcy5wcm9wcy5lZGl0aW5nKSB7XG4gICAgICBjbHMgKz0gJyBjb21tZW50ZWRfY29tbWVudC0tZWRpdGluZydcbiAgICB9XG4gICAgaWYgKHRoaXMucHJvcHMuY2FuRWRpdCkge1xuICAgICAgY2xzICs9ICcgY29tbWVudGVkX2NvbW1lbnQtLW1pbmUnXG4gICAgfVxuICAgIGlmICh0aGlzLnByb3BzLmlzUmVwbHkpIHtcbiAgICAgIGNscyArPSAnIGNvbW1lbnRlZF9jb21tZW50LS1yZXBseSdcbiAgICB9XG4gICAgaWYgKHRoaXMucHJvcHMuaGFzUmVwbGllcykge1xuICAgICAgY2xzICs9ICcgY29tbWVudGVkX2NvbW1lbnQtLWhhcy1yZXBsaWVzJ1xuICAgIH1cblxuICAgIHZhciB2b3RlcyA9IHRoaXMuZ2V0Vm90ZXMoKVxuICAgIGlmICh2b3Rlcy5mbGFnQ291bnQgPiAyICYmIHRoaXMucHJvcHMudXNlcmlkICE9PSB0aGlzLnByb3BzLmRhdGEudXNlcmlkKSB7XG4gICAgICByZXR1cm4gUmVhY3QuRE9NLmRpdigge2NsYXNzTmFtZTpjbHMgKyBcIiBjb21tZW50ZWRfY29tbWVudC0tZmxhZ2dlZFwifSwgXG4gICAgICAgIFJlYWN0LkRPTS5zcGFuKCB7Y2xhc3NOYW1lOlwiY29tbWVudGVkX3BpYyBmYS1zdGFjayBmYS1sZ1wifSwgXG4gICAgICAgICAgUmVhY3QuRE9NLmkoIHtjbGFzc05hbWU6XCJmYSBmYS1jaXJjbGUgZmEtc3RhY2stMnhcIn0pLFxuICAgICAgICAgIFJlYWN0LkRPTS5pKCB7Y2xhc3NOYW1lOlwiZmEgZmEtZmxhZyBmYS1zdGFjay0xeCBmYS1pbnZlcnNlXCJ9KVxuICAgICAgICApLFxuICAgICAgICBSZWFjdC5ET00uc3Bhbigge2NsYXNzTmFtZTpcImRpc3BsYXktbmFtZVwifSwgXG4gICAgICAgICAgXCJmbGFnZ2VkIGNvbW1lbnQgaGlkZGVuXCJcbiAgICAgICAgKVxuICAgICAgKVxuICAgIH1cblxuICAgIHJldHVybiBSZWFjdC5ET00uZGl2KCB7Y2xhc3NOYW1lOmNsc30sIFxuICAgICAgUmVhY3QuRE9NLmltZygge2NsYXNzTmFtZTpcImNvbW1lbnRlZF9waWNcIiwgc3JjOmNvbW1lbnQucGljdHVyZX0pLFxuICAgICAgUmVhY3QuRE9NLmRpdigge2NsYXNzTmFtZTpcInJpZ2h0XCJ9LCBcbiAgICAgICAgdGhpcy5idXR0b25zKHZvdGVzKSxcbiAgICAgICAgUmVhY3QuRE9NLnN0cm9uZygge2NsYXNzTmFtZTpcImRpc3BsYXktbmFtZVwifSwgY29tbWVudC5kaXNwbGF5TmFtZSksXG4gICAgICAgIGNvbW1lbnQuY3JlYXRlZCAmJiAvLyBUT0RPIGhhdmUgdGhpcyB0aW1lIGF1dG8tdXBkYXRlXG4gICAgICAgICAgUmVhY3QuRE9NLnNwYW4oIHtjbGFzc05hbWU6XCJkaXNwbGF5LXRpbWVcIn0sIG1vbWVudChjb21tZW50LmNyZWF0ZWQpLmZyb21Ob3coKSksXG4gICAgICAgIHRoaXMucHJvcHMucGFyZW50RGVsZXRlZCAmJlxuICAgICAgICAgIFJlYWN0LkRPTS5zcGFuKCB7Y2xhc3NOYW1lOlwicGFyZW50LWRlbGV0ZWRcIn0sIFwiaW4gcmVwbHkgdG8gYSBkZWxldGVkIGNvbW1lbnRcIiksXG4gICAgICAgIHRoaXMucHJvcHMuY3JlYXRpbmcgJiZcbiAgICAgICAgICBSZWFjdC5ET00uYnV0dG9uKCB7Y2xhc3NOYW1lOlwiY29tbWVudGVkX2xvZ291dFwiLCBvbkNsaWNrOnRoaXMucHJvcHMub25Mb2dvdXR9LCBcImxvZ291dFwiKSxcbiAgICAgICAgdGhpcy5ib2R5KClcbiAgICAgIClcbiAgICApO1xuICB9XG59KTtcblxubW9kdWxlLmV4cG9ydHMgPSBDb21tZW50RGlzcGxheVxuIiwiLyoqIEBqc3ggUmVhY3QuRE9NICovXG52YXIgQ29tbWVudERpc3BsYXkgPSByZXF1aXJlKCcuL2NvbW1lbnQtZGlzcGxheS5qc3gnKVxuXG52YXIgQ29tbWVudCA9IFJlYWN0LmNyZWF0ZUNsYXNzKHtkaXNwbGF5TmFtZTogJ0NvbW1lbnQnLFxuICBwcm9wVHlwZXM6IHtcbiAgICBkYXRhOiBSZWFjdC5Qcm9wVHlwZXMub2JqZWN0LmlzUmVxdWlyZWQsXG4gICAgY2FuRWRpdDogUmVhY3QuUHJvcFR5cGVzLmJvb2wuaXNSZXF1aXJlZCxcbiAgICB1c2VyaWQ6IFJlYWN0LlByb3BUeXBlcy5zdHJpbmcuaXNSZXF1aXJlZCxcbiAgICBkYjogUmVhY3QuUHJvcFR5cGVzLm9iamVjdCxcbiAgfSxcblxuICBnZXRJbml0aWFsU3RhdGU6IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgZWRpdGluZzogZmFsc2UsXG4gICAgICByZXBseWluZzogZmFsc2UsXG4gICAgfVxuICB9LFxuXG4gIG9uUmVtb3ZlOiBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5wcm9wcy5kYi5yZW1vdmVDb21tZW50KHRoaXMucHJvcHMuZGF0YS5faWQpXG4gIH0sXG5cbiAgb25FZGl0OiBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5zZXRTdGF0ZSh7ZWRpdGluZzogdHJ1ZX0pXG4gIH0sXG5cbiAgb25SZXBseTogZnVuY3Rpb24gKCkge1xuICAgIGlmICh0aGlzLnByb3BzLmlzUmVwbHkpIHJldHVyblxuICAgIHRoaXMuc2V0U3RhdGUoe2VkaXRpbmc6IGZhbHNlLCByZXBseWluZzogdHJ1ZX0pO1xuICB9LFxuXG4gIG9uQ2xlYXJWb3RlOiBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5wcm9wcy5kYi5jbGVhclZvdGUodGhpcy5wcm9wcy5kYXRhLl9pZCwgdGhpcy5wcm9wcy51c2VyaWQpXG4gIH0sXG5cbiAgb25Eb3dudm90ZTogZnVuY3Rpb24gKGVyYXNlKSB7XG4gICAgdGhpcy5wcm9wcy5kYi5kb3duVm90ZSh0aGlzLnByb3BzLmRhdGEuX2lkLCB0aGlzLnByb3BzLnVzZXJpZClcbiAgfSxcblxuICBvblVwdm90ZTogZnVuY3Rpb24gKCkge1xuICAgIHRoaXMucHJvcHMuZGIudXBWb3RlKHRoaXMucHJvcHMuZGF0YS5faWQsIHRoaXMucHJvcHMudXNlcmlkKVxuICB9LFxuXG4gIG9uRmxhZzogZnVuY3Rpb24gKGZsYWcpIHtcbiAgICB0aGlzLnByb3BzLmRiLmZsYWcodGhpcy5wcm9wcy5kYXRhLl9pZCwgdGhpcy5wcm9wcy51c2VyaWQsIGZsYWcpXG4gIH0sXG5cbiAgY2FuY2VsRWRpdDogZnVuY3Rpb24gKCkge1xuICAgIHRoaXMuc2V0U3RhdGUoe2VkaXRpbmc6IGZhbHNlfSlcbiAgfSxcblxuICBkb25lRWRpdGluZzogZnVuY3Rpb24gKHRleHQpIHtcbiAgICBpZiAoIXRoaXMuc3RhdGUuZWRpdGluZykgcmV0dXJuXG4gICAgaWYgKCF0ZXh0KSByZXR1cm5cbiAgICB0aGlzLnByb3BzLmRiLmVkaXRDb21tZW50KHRoaXMucHJvcHMuZGF0YS5faWQsIHRleHQpXG4gICAgdGhpcy5zZXRTdGF0ZSh7ZWRpdGluZzogZmFsc2V9KVxuICB9LFxuXG4gIGRvbmVSZXBseWluZzogZnVuY3Rpb24gKHRleHQpIHtcbiAgICBpZiAoIXRoaXMuc3RhdGUucmVwbHlpbmcpIHJldHVyblxuICAgIGlmICghdGV4dCkgcmV0dXJuXG4gICAgdGhpcy5wcm9wcy5kYi5hZGRDb21tZW50KHRleHQsIFwicmVwbHk6XCIgKyB0aGlzLnByb3BzLmRhdGEuX2lkLCAnJylcbiAgICB0aGlzLnNldFN0YXRlKHtyZXBseWluZzogZmFsc2V9KVxuICB9LFxuXG4gIGNhbmNlbFJlcGx5OiBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5zZXRTdGF0ZSh7cmVwbHlpbmc6IGZhbHNlfSlcbiAgfSxcblxuICByZW5kZXJSZXBsaWVzOiBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIHJlcGxpZXMgPSB0aGlzLnByb3BzLnJlcGxpZXNcbiAgICBpZiAoIXJlcGxpZXMubGVuZ3RoICYmICF0aGlzLnN0YXRlLnJlcGx5aW5nKSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gICAgdmFyIHVzZXIgPSB0aGlzLnByb3BzLnVzZXJcbiAgICByZXR1cm4gUmVhY3QuRE9NLmRpdigge2NsYXNzTmFtZTpcImNvbW1lbnRlZF9yZXBsaWVzXCJ9LCBcbiAgICAgIHJlcGxpZXMubWFwKGZ1bmN0aW9uIChjb21tZW50KSB7XG4gICAgICAgIHJldHVybiBDb21tZW50KHtcbiAgICAgICAgICBrZXk6IGNvbW1lbnQuX2lkLFxuICAgICAgICAgIGlzUmVwbHk6IHRydWUsXG4gICAgICAgICAgcmVwbGllczogW10sXG4gICAgICAgICAgY2FuRWRpdDogdXNlciAmJiB1c2VyLnVpZCA9PSBjb21tZW50LnVzZXJpZCxcbiAgICAgICAgICBjYW5Wb3RlOiAhIXVzZXIsXG4gICAgICAgICAgdXNlcmlkOiB1c2VyICYmIHVzZXIudWlkLFxuICAgICAgICAgIGRhdGE6IGNvbW1lbnQsXG4gICAgICAgICAgdXNlcjogdXNlcixcbiAgICAgICAgICBkYjogdGhpcy5wcm9wcy5kYixcbiAgICAgICAgfSlcbiAgICAgIH0uYmluZCh0aGlzKSksXG4gICAgICB0aGlzLnN0YXRlLnJlcGx5aW5nICYmIHVzZXIgJiYgQ29tbWVudERpc3BsYXkoe1xuICAgICAgICBlZGl0aW5nOiB0cnVlLFxuICAgICAgICBjYW5FZGl0OiB0cnVlLFxuICAgICAgICBjYW5Wb3RlOiBmYWxzZSxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIHBpY3R1cmU6IHRoaXMucHJvcHMudXNlci5waWN0dXJlLFxuICAgICAgICAgIGRpc3BsYXlOYW1lOiB0aGlzLnByb3BzLnVzZXIuZGlzcGxheU5hbWUsXG4gICAgICAgICAgdGV4dDogJydcbiAgICAgICAgfSxcbiAgICAgICAgb25Mb2dvdXQ6IHRoaXMub25Mb2dvdXQsXG4gICAgICAgIHVzZXJpZDogdGhpcy5wcm9wcy51c2VyaWQsXG4gICAgICAgIGlzUmVwbHk6IHRydWUsXG4gICAgICAgIGNyZWF0aW5nOiB0cnVlLFxuXG4gICAgICAgIGNhbmNlbEVkaXQ6IHRoaXMuY2FuY2VsUmVwbHksXG4gICAgICAgIGRvbmVFZGl0aW5nOiB0aGlzLmRvbmVSZXBseWluZyxcbiAgICAgICAgb25SZW1vdmU6IHRoaXMuY2FuY2VsUmVwbHlcbiAgICAgIH0pXG4gICAgKVxuICB9LFxuXG4gIG9uTG9nb3V0OiBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5zZXRTdGF0ZSh7cmVwbHlpbmc6IGZhbHNlLCBlZGl0aW5nOiBmYWxzZX0pXG4gICAgdGhpcy5wcm9wcy5kYi5sb2dvdXQoKVxuICB9LFxuXG4gIHJlbmRlcjogZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBSZWFjdC5ET00uZGl2KCB7Y2xhc3NOYW1lOlwiY29tbWVudGVkX29uZVwifSwgXG4gICAgICBDb21tZW50RGlzcGxheSh7XG4gICAgICAgIGVkaXRpbmc6IHRoaXMuc3RhdGUuZWRpdGluZyxcbiAgICAgICAgY2FuRWRpdDogdGhpcy5wcm9wcy5jYW5FZGl0LFxuICAgICAgICBjYW5Wb3RlOiB0aGlzLnByb3BzLmNhblZvdGUsXG4gICAgICAgIGRhdGE6IHRoaXMucHJvcHMuZGF0YSxcbiAgICAgICAgZGI6IHRoaXMucHJvcHMuZGIsXG4gICAgICAgIGlzUmVwbHk6IHRoaXMucHJvcHMuaXNSZXBseSxcbiAgICAgICAgaGFzUmVwbGllczogKHRoaXMucHJvcHMudXNlcmlkICYmIHRoaXMuc3RhdGUucmVwbHlpbmcpIHx8IHRoaXMucHJvcHMucmVwbGllcyAmJiB0aGlzLnByb3BzLnJlcGxpZXMubGVuZ3RoLFxuICAgICAgICB1c2VyaWQ6IHRoaXMucHJvcHMudXNlcmlkLFxuICAgICAgICBwYXJlbnREZWxldGVkOiB0aGlzLnByb3BzLnBhcmVudERlbGV0ZWQsXG5cbiAgICAgICAgb25FZGl0OiB0aGlzLm9uRWRpdCxcbiAgICAgICAgb25GbGFnOiB0aGlzLm9uRmxhZyxcbiAgICAgICAgb25SZXBseTogIXRoaXMucHJvcHMuaXNSZXBseSAmJiB0aGlzLm9uUmVwbHksXG4gICAgICAgIGNhbmNlbFJlcGx5OiB0aGlzLmNhbmNlbFJlcGx5LFxuICAgICAgICBvbkxvZ291dDogdGhpcy5vbkxvZ291dCxcbiAgICAgICAgb25SZW1vdmU6IHRoaXMub25SZW1vdmUsXG4gICAgICAgIG9uVXB2b3RlOiB0aGlzLm9uVXB2b3RlLFxuICAgICAgICBvbkRvd252b3RlOiB0aGlzLm9uRG93bnZvdGUsXG4gICAgICAgIG9uQ2xlYXJWb3RlOiB0aGlzLm9uQ2xlYXJWb3RlLFxuICAgICAgICBkb25lRWRpdGluZzogdGhpcy5kb25lRWRpdGluZyxcbiAgICAgICAgY2FuY2VsRWRpdDogdGhpcy5jYW5jZWxFZGl0LFxuICAgICAgfSksXG4gICAgICB0aGlzLnJlbmRlclJlcGxpZXMoKVxuICAgIClcbiAgfVxufSk7XG5cbm1vZHVsZS5leHBvcnRzID0gQ29tbWVudDtcbiIsIi8qKiBAanN4IFJlYWN0LkRPTSAqL1xudmFyIEF1dG9UZXh0YXJlYSA9IHJlcXVpcmUoJy4vYXV0by10ZXh0YXJlYS5qc3gnKVxudmFyIENvbW1lbnREaXNwbGF5ID0gcmVxdWlyZSgnLi9jb21tZW50LWRpc3BsYXkuanN4JylcblxudmFyIENyZWF0ZUNvbW1lbnQgPSBSZWFjdC5jcmVhdGVDbGFzcyh7ZGlzcGxheU5hbWU6ICdDcmVhdGVDb21tZW50JyxcbiAgcHJvcFR5cGVzOiB7XG4gICAgb25IaWRlOiBSZWFjdC5Qcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkLFxuICAgIHRhcmdldDogUmVhY3QuUHJvcFR5cGVzLnN0cmluZy5pc1JlcXVpcmVkLFxuICAgIGRiOiBSZWFjdC5Qcm9wVHlwZXMub2JqZWN0LmlzUmVxdWlyZWQsXG4gICAgdXNlcjogUmVhY3QuUHJvcFR5cGVzLm9iamVjdC5pc1JlcXVpcmVkXG4gIH0sXG4gIGdldEluaXRpYWxTdGF0ZTogZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiB7XG4gICAgICB0ZXh0OiAnJ1xuICAgIH1cbiAgfSxcblxuICBfb25TdWJtaXQ6IGZ1bmN0aW9uICh0ZXh0KSB7XG4gICAgaWYgKCF0ZXh0KSByZXR1cm5cbiAgICB0aGlzLnByb3BzLmRiLmFkZENvbW1lbnQodGV4dCwgdGhpcy5wcm9wcy50YXJnZXQsIGZhbHNlKVxuICAgIHRoaXMucHJvcHMub25IaWRlKClcbiAgfSxcblxuICByZW5kZXI6IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gQ29tbWVudERpc3BsYXkoe1xuICAgICAgY2FuRWRpdDogdHJ1ZSxcbiAgICAgIGVkaXRpbmc6IHRydWUsXG4gICAgICBjcmVhdGluZzogdHJ1ZSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgcGljdHVyZTogdGhpcy5wcm9wcy51c2VyLnBpY3R1cmUsXG4gICAgICAgIGRpc3BsYXlOYW1lOiB0aGlzLnByb3BzLnVzZXIuZGlzcGxheU5hbWUsXG4gICAgICAgIHRleHQ6ICcnLFxuICAgICAgfSxcbiAgICAgIHVzZXJpZDogdGhpcy5wcm9wcy51c2VyLnVpZCxcblxuICAgICAgb25Mb2dvdXQ6IHRoaXMucHJvcHMuZGIubG9nb3V0LmJpbmQodGhpcy5wcm9wcy5kYiksXG4gICAgICBjYW5jZWxFZGl0OiB0aGlzLnByb3BzLm9uSGlkZSxcbiAgICAgIGRvbmVFZGl0aW5nOiB0aGlzLl9vblN1Ym1pdCxcbiAgICAgIG9uUmVtb3ZlOiB0aGlzLnByb3BzLm9uSGlkZVxuICAgIH0pXG4gIH1cbn0pO1xuXG5tb2R1bGUuZXhwb3J0cyA9IENyZWF0ZUNvbW1lbnRcblxuIiwiXG5tb2R1bGUuZXhwb3J0cyA9IERCRmlyZWJhc2VcblxuZnVuY3Rpb24gREJGaXJlYmFzZShvcHRpb25zKSB7XG4gIHRoaXMuZGIgPSBuZXcgRmlyZWJhc2UoJ2h0dHBzOi8vJyArIG9wdGlvbnMuZmlyZWJhc2UgKyAnLmZpcmViYXNlaW8uY29tL2NvbW1lbnRzLycgKyBvcHRpb25zLnNsdWcpO1xuICB2YXIgb25WYWx1ZVxuICB0aGlzLmRiLm9uKCd2YWx1ZScsIG9uVmFsdWUgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5kYi5vZmYoJ3ZhbHVlJywgb25WYWx1ZSlcbiAgICB0aGlzLmxvYWRlZCA9IHRydWVcbiAgfS5iaW5kKHRoaXMpKTtcbiAgdGhpcy51c2VyID0gbnVsbFxuICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zXG5cbiAgdGhpcy5fYXV0aCA9IG5ldyBGaXJlYmFzZVNpbXBsZUxvZ2luKHRoaXMuZGIsIHRoaXMuX29uTG9naW4uYmluZCh0aGlzKSk7XG4gIHRoaXMubGlIYW5kZXJzID0gW11cbn1cblxuREJGaXJlYmFzZS5wcm90b3R5cGUgPSB7XG5cbiAgLy8gbm9ybWFsIGVkaXRzXG5cbiAgYWRkQ29tbWVudDogZnVuY3Rpb24gKHRleHQsIHRhcmdldCwgcXVvdGUpIHtcbiAgICBpZiAoIXRoaXMudXNlcikge1xuICAgICAgcmV0dXJuIGNvbnNvbGUuZXJyb3IoXCJOb3QgbG9nZ2VkIGluXCIpO1xuICAgIH1cbiAgICB0aGlzLmRiLnB1c2goe1xuICAgICAgY3JlYXRlZDogRGF0ZS5ub3coKSxcbiAgICAgIGRpc3BsYXlOYW1lOiB0aGlzLnVzZXIuZGlzcGxheU5hbWUsXG4gICAgICBwaWN0dXJlOiB0aGlzLnVzZXIucGljdHVyZSxcbiAgICAgIHVzZXJpZDogdGhpcy51c2VyLnVpZCxcbiAgICAgIHRleHQ6IHRleHQsXG4gICAgICB0YXJnZXQ6IHRhcmdldCxcbiAgICAgIHF1b3RlOiBxdW90ZVxuICAgIH0pXG4gIH0sXG5cbiAgZWRpdENvbW1lbnQ6IGZ1bmN0aW9uIChpZCwgdGV4dCkge1xuICAgIGlmICghdGhpcy51c2VyKSB7XG4gICAgICByZXR1cm4gY29uc29sZS5lcnJvcihcIk5vdCBsb2dnZWQgaW5cIik7XG4gICAgfVxuICAgIHRoaXMuZGIuY2hpbGQoaWQpLnVwZGF0ZSh7dGV4dDogdGV4dH0pXG4gIH0sXG5cbiAgcmVtb3ZlQ29tbWVudDogZnVuY3Rpb24gKGlkKSB7XG4gICAgaWYgKCF0aGlzLnVzZXIpIHtcbiAgICAgIHJldHVybiBjb25zb2xlLmVycm9yKFwiTm90IGxvZ2dlZCBpblwiKTtcbiAgICB9XG4gICAgdGhpcy5kYi5jaGlsZChpZCkucmVtb3ZlKClcbiAgfSxcblxuICAvLyB2b3RpbmchIVxuXG4gIGZsYWc6IGZ1bmN0aW9uIChpZCwgdWlkLCBmbGFnKSB7XG4gICAgdGhpcy5kYi5jaGlsZChpZCkuY2hpbGQoJ2ZsYWdzJykuY2hpbGQodWlkKS5zZXQoZmxhZylcbiAgfSxcblxuICBkb3duVm90ZTogZnVuY3Rpb24gKGlkLCB1aWQpIHtcbiAgICB0aGlzLmRiLmNoaWxkKGlkKS5jaGlsZCgndm90ZXMnKS5jaGlsZCh1aWQpLnNldChmYWxzZSlcbiAgfSxcblxuICBjbGVhclZvdGU6IGZ1bmN0aW9uIChpZCwgdWlkKSB7XG4gICAgdGhpcy5kYi5jaGlsZChpZCkuY2hpbGQoJ3ZvdGVzJykuY2hpbGQodWlkKS5yZW1vdmUoKVxuICB9LFxuXG4gIHVwVm90ZTogZnVuY3Rpb24gKGlkLCB1aWQpIHtcbiAgICB0aGlzLmRiLmNoaWxkKGlkKS5jaGlsZCgndm90ZXMnKS5jaGlsZCh1aWQpLnNldCh0cnVlKVxuICB9LFxuXG4gIGxvZ2luOiBmdW5jdGlvbiAodHlwZSkge1xuICAgIHRoaXMuX2F1dGgubG9naW4odHlwZSwge1xuICAgICAgcmVtZW1iZXJNZTogdHJ1ZVxuICAgIH0pXG4gIH0sXG5cbiAgX29uTG9naW46IGZ1bmN0aW9uIChlcnIsIHVzZXIpIHtcbiAgICBpZiAoZXJyIHx8ICF1c2VyKSB7XG4gICAgICByZXR1cm4gdGhpcy5maXJlTG9nZ2VkaW4obnVsbClcbiAgICB9XG4gICAgdXNlci5waWN0dXJlID0gKHVzZXIudGhpcmRQYXJ0eVVzZXJEYXRhLnByb2ZpbGVfaW1hZ2VfdXJsIHx8IC8vIHR3aXR0ZXJcbiAgICAgICAgICAgICAgICAgICAgdXNlci50aGlyZFBhcnR5VXNlckRhdGEucGljdHVyZSB8fCAgLy8gZ29vZ2xlXG4gICAgICAgICAgICAgICAgICAgIHVzZXIudGhpcmRQYXJ0eVVzZXJEYXRhLmF2YXRhcl91cmwpIC8vIGdpdGh1YlxuICAgIC8vIGZhY2Vib29rXG4gICAgaWYgKHVzZXIucGljdHVyZSAmJiB1c2VyLnBpY3R1cmUuZGF0YSkge1xuICAgICAgdXNlci5waWN0dXJlID0gdXNlci5waWN0dXJlLmRhdGEudXJsXG4gICAgfVxuICAgIHRoaXMudXNlciA9IHVzZXJcbiAgICB0aGlzLmZpcmVMb2dnZWRpbih1c2VyKVxuICB9LFxuXG4gIGZpcmVMb2dnZWRpbjogZnVuY3Rpb24gKHVzZXIpIHtcbiAgICB0aGlzLmxpSGFuZGVycy5mb3JFYWNoKGZ1bmN0aW9uIChmbikge1xuICAgICAgZm4odXNlcilcbiAgICB9KVxuICB9LFxuXG4gIGxvZ291dDogZnVuY3Rpb24gKCkge1xuICAgIHRoaXMuX2F1dGgubG9nb3V0KClcbiAgfSxcblxuICBvbkxvZ2luOiBmdW5jdGlvbiAoY2IpIHtcbiAgICB0aGlzLmxpSGFuZGVycy5wdXNoKGNiKVxuICB9LFxuXG4gIG9mZkxvZ2luOiBmdW5jdGlvbiAoY2IpIHtcbiAgICB2YXIgaSA9IHRoaXMubGlIYW5kZXJzLmluZGV4T2YoY2IpXG4gICAgaWYgKGkgPT09IC0xKSByZXR1cm5cbiAgICB0aGlzLmxpSGFuZGVycy5zcGxpY2UoaSwgMSlcbiAgfSxcblxuICBvbmNlTG9hZGVkOiBmdW5jdGlvbiAoZG9uZSkge1xuICAgIHZhciBvblZhbHVlXG4gICAgdGhpcy5kYi5vbigndmFsdWUnLCBvblZhbHVlID0gZnVuY3Rpb24gKCkge1xuICAgICAgZG9uZSgpXG4gICAgICB0aGlzLmRiLm9mZigndmFsdWUnLCBvblZhbHVlKVxuICAgIH0uYmluZCh0aGlzKSlcbiAgfSxcblxuICAvLyByZWdpc3RlciBldmVudCBsaXN0ZW5lcnNcbiAgb25BZGQ6IGZ1bmN0aW9uIChjYikge1xuICAgIHRoaXMuZGIub24oJ2NoaWxkX2FkZGVkJywgZnVuY3Rpb24gKHNuYXBzaG90KSB7XG4gICAgICB2YXIgdmFsID0gc25hcHNob3QudmFsKClcbiAgICAgIHZhbC5faWQgPSBzbmFwc2hvdC5uYW1lKClcbiAgICAgIGNiKHZhbCk7XG4gICAgfSk7XG4gIH0sXG4gIG9uQ2hhbmdlOiBmdW5jdGlvbiAoY2IpIHtcbiAgICB0aGlzLmRiLm9uKCdjaGlsZF9jaGFuZ2VkJywgZnVuY3Rpb24gKHNuYXBzaG90KSB7XG4gICAgICB2YXIgdmFsID0gc25hcHNob3QudmFsKClcbiAgICAgIHZhbC5faWQgPSBzbmFwc2hvdC5uYW1lKClcbiAgICAgIGNiKHZhbClcbiAgICB9KTtcbiAgfSxcbiAgb25SZW1vdmU6IGZ1bmN0aW9uIChjYikge1xuICAgIHRoaXMuZGIub24oJ2NoaWxkX3JlbW92ZWQnLCBmdW5jdGlvbiAoc25hcHNob3QpIHtcbiAgICAgIGNiKHNuYXBzaG90Lm5hbWUoKSk7XG4gICAgfSk7XG4gIH0sXG59XG4iLCJcbnZhciBEQkZpcmViYXNlID0gcmVxdWlyZSgnLi9kYi1maXJlYmFzZScpO1xuLy8gdmFyIERCSG9vZGllID0gcmVxdWlyZSgnLi9kYi1ob29kaWUnKTtcblxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAob3B0aW9ucykge1xuICBzd2l0Y2ggKG9wdGlvbnMudHlwZSkge1xuICAgIC8qIE5vdCByZWFkeSB5ZXRcbiAgICBjYXNlIFwiaG9vZGllXCI6XG4gICAgICByZXR1cm4gbmV3IERCSG9vZGllKG9wdGlvbnMpOyovXG4gICAgY2FzZSBcImZpcmViYXNlXCI6XG4gICAgICByZXR1cm4gbmV3IERCRmlyZWJhc2Uob3B0aW9ucyk7XG4gICAgZGVmYXVsdDpcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJJbnZhbGlkIGJhY2tlbmQgc3BlY2lmaWVkXCIsIG9wdGlvbnMudHlwZSwgb3B0aW9ucyk7XG4gIH1cbn1cblxuIiwiXG5pZiAod2luZG93Lm1hcmtlZCkge1xuICBtYXJrZWQuc2V0T3B0aW9ucyh7XG4gICAgZ2ZtOiB0cnVlLFxuICAgIHRhYmxlczogdHJ1ZSxcbiAgICBicmVha3M6IHRydWUsXG4gICAgcGVkYW50aWM6IGZhbHNlLFxuICAgIHNhbml0aXplOiBmYWxzZSxcbiAgICBzbWFydExpc3RzOiB0cnVlLFxuICAgIHNtYXJ0eXBhbnRzOiB0cnVlLFxuICB9KVxuICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uICh0ZXh0LCBjbHMpIHtcbiAgICByZXR1cm4gUmVhY3QuRE9NLmRpdih7XG4gICAgICBjbGFzc05hbWU6IGNscyxcbiAgICAgIGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MOiB7XG4gICAgICAgIF9faHRtbDogbWFya2VkKHRleHQpXG4gICAgICB9XG4gICAgfSk7XG4gIH1cbn0gZWxzZSB7XG4gIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKHgsIGNscykge1xuICAgIHJldHVybiBSZWFjdC5ET00uZGl2KHtjbGFzc05hbWU6IGNsc30sIHgpXG4gIH1cbn1cblxuIiwiXG52YXIgY2xlYW5TbHVnID0gcmVxdWlyZSgnLi9jbGVhbi1zbHVnLmpzJylcbiAgLCBnZXREYiA9IHJlcXVpcmUoJy4vZGInKVxuXG4gIC8vICwgSW5saW5lQ29tbWVudHMgPSByZXF1aXJlKCcuL2lubGluZS1jb21tZW50cy5qc3gnKVxuICAsIE1haW5Db21tZW50cyA9IHJlcXVpcmUoJy4vbWFpbi1jb21tZW50cy5qc3gnKVxuXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChvcHRpb25zKSB7XG4gIG9wdGlvbnMuc2x1ZyA9IGNsZWFuU2x1ZyhvcHRpb25zLnNsdWcpXG5cbiAgdmFyIGRiID0gd2luZG93LmRiID0gZ2V0RGIob3B0aW9ucylcbiAgaWYgKCFkYikgcmV0dXJuIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBpbml0aWFsaXplIGRiJylcblxuICB2YXIgbm9kZXNcbiAgaWYgKG9wdGlvbnMuaW5saW5lICYmIGZhbHNlKSB7XG4gICAgdmFyIGJvZHkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKG9wdGlvbnMuaW5saW5lKVxuICAgIGJvZHkuY2xhc3NMaXN0LmFkZCgnY29tbWVudGVkX2lubGluZS1ib2R5JylcbiAgICBub2RlcyA9IGJvZHkucXVlcnlTZWxlY3RvckFsbChvcHRpb25zLmlubGluZSArICcgcCcpXG4gICAgbm9kZXMuZm9yRWFjaChmdW5jdGlvbiAobm9kZSkge1xuICAgICAgUmVhY3QucmVuZGVyQ29tcG9uZW50KElubGluZUNvbW1lbnRzKHtcbiAgICAgICAgYXV0aDogYXV0aCxcbiAgICAgICAgZGI6IGRiXG4gICAgICB9KSwgbm9kZSk7XG4gICAgfSk7XG4gIH1cblxuICBSZWFjdC5yZW5kZXJDb21wb25lbnQoTWFpbkNvbW1lbnRzKHtcbiAgICBhdXRoOiBvcHRpb25zLmF1dGgsXG4gICAgZGI6IGRiXG4gIH0pLCBvcHRpb25zLm1haW4pO1xuXG4gIC8vIGNyZWF0ZSB0aGUgbWFpbiBjb21wb25lbnQsIHRoZW4gY3JlYXRlIGEgc2lkZWJhciBjb21wb25lbnRcbn1cblxuIiwiLyoqIEBqc3ggUmVhY3QuRE9NICovXG52YXIgSUNPTlMgPSB7XG4gIGZhY2Vib29rOiAnZmFjZWJvb2snLFxuICB0d2l0dGVyOiAndHdpdHRlcicsXG4gIGdvb2dsZTogJ2dvb2dsZScsXG4gIGdpdGh1YjogJ2dpdGh1Yidcbn1cblxudmFyIExvZ2luID0gUmVhY3QuY3JlYXRlQ2xhc3Moe2Rpc3BsYXlOYW1lOiAnTG9naW4nLFxuICBwcm9wVHlwZXM6IHtcbiAgICBkYjogUmVhY3QuUHJvcFR5cGVzLm9iamVjdC5pc1JlcXVpcmVkLFxuICAgIGF1dGg6IFJlYWN0LlByb3BUeXBlcy5hcnJheS5pc1JlcXVpcmVkLFxuICAgIG9uTG9naW46IFJlYWN0LlByb3BUeXBlcy5mdW5jLmlzUmVxdWlyZWQsXG4gICAgb25DYW5jZWw6IFJlYWN0LlByb3BUeXBlcy5mdW5jLmlzUmVxdWlyZWRcbiAgfSxcblxuICBnZXRJbml0aWFsU3RhdGU6IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgbG9hZGluZzogZmFsc2VcbiAgICB9XG4gIH0sXG5cbiAgY29tcG9uZW50RGlkTW91bnQ6IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLnByb3BzLmRiLm9uTG9naW4odGhpcy5fb25Mb2dpbilcbiAgfSxcbiAgY29tcG9uZW50V2lsbFVubW91bnQ6IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLnByb3BzLmRiLm9mZkxvZ2luKHRoaXMuX29uTG9naW4pXG4gIH0sXG5cbiAgX29uTG9naW46IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLnNldFN0YXRlKHtsb2FkaW5nOiBmYWxzZX0pXG4gIH0sXG5cbiAgb25DbGljazogZnVuY3Rpb24gKHR5cGUpIHtcbiAgICB0aGlzLnNldFN0YXRlKHtsb2FkaW5nOiB0eXBlfSlcbiAgICB0aGlzLnByb3BzLmRiLmxvZ2luKHR5cGUpXG4gIH0sXG5cbiAgcmVuZGVyOiBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKHRoaXMuc3RhdGUubG9hZGluZykge1xuICAgICAgcmV0dXJuIFJlYWN0LkRPTS5kaXYoIHtjbGFzc05hbWU6XCJjb21tZW50ZWRfbG9naW4tLWxvYWRpbmcgY29tbWVudGVkX2xvZ2luXCJ9LCBcbiAgICAgICAgXCJDb25uZWN0aW5nIHRvIFwiLCB0aGlzLnN0YXRlLmxvYWRpbmcsXG4gICAgICAgIFJlYWN0LkRPTS5pKCB7Y2xhc3NOYW1lOlwiZmEgZmEtc3BpbiBmYS1zcGlubmVyXCJ9KVxuICAgICAgKVxuICAgIH1cblxuICAgIHJldHVybiBSZWFjdC5ET00uZGl2KCB7Y2xhc3NOYW1lOlwiY29tbWVudGVkX2xvZ2luXCJ9LCBcbiAgICAgIHRoaXMucHJvcHMuYXV0aC5tYXAoZnVuY3Rpb24gKHR5cGUpIHtcbiAgICAgICAgdmFyIGljb24gPSBJQ09OU1t0eXBlXVxuICAgICAgICAgICwgY2xzID0gXCJjb21tZW50ZWRfbG9naW4tdHlwZVwiXG4gICAgICAgIGNscyArPSAnIGNvbW1lbnRlZF9sb2dpbi10eXBlLS0nICsgdHlwZVxuICAgICAgICByZXR1cm4gUmVhY3QuRE9NLmJ1dHRvbigge2tleTp0eXBlLCBjbGFzc05hbWU6Y2xzLCBvbkNsaWNrOnRoaXMub25DbGljay5iaW5kKHRoaXMsIHR5cGUpfSwgXG4gICAgICAgICAgUmVhY3QuRE9NLnNwYW4oIHtjbGFzc05hbWU6XCJjb21tZW50ZWRfcGljIGZhLXN0YWNrIGZhLWxnXCJ9LCBcbiAgICAgICAgICAgIFJlYWN0LkRPTS5pKCB7Y2xhc3NOYW1lOlwiZmEgZmEtY2lyY2xlIGZhLXN0YWNrLTJ4XCJ9KSxcbiAgICAgICAgICAgIFJlYWN0LkRPTS5pKCB7Y2xhc3NOYW1lOlwiZmEgZmEtXCIgKyBpY29uICsgXCIgZmEtc3RhY2stMXggZmEtaW52ZXJzZVwifSlcbiAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgICB9LmJpbmQodGhpcykpLFxuICAgICAgUmVhY3QuRE9NLmJ1dHRvbigge2NsYXNzTmFtZTpcImNvbW1lbnRlZF9sb2dpbi10eXBlIGNvbW1lbnRlX2xvZ2luLXR5cGUtLWNhbmNlbFwiLFxuICAgICAgICBvbkNsaWNrOnRoaXMucHJvcHMub25DYW5jZWx9LCBcIsOXXCJcbiAgICAgIClcbiAgICApO1xuICB9XG59KTtcblxubW9kdWxlLmV4cG9ydHMgPSBMb2dpblxuIiwiLyoqIEBqc3ggUmVhY3QuRE9NICovXG52YXIgbWl4aW5nID0gcmVxdWlyZSgnLi9taXhpbicpXG4gICwgQ29tbWVudCA9IHJlcXVpcmUoJy4vY29tbWVudC5qc3gnKVxuICAsIFNob3dBbGxlciA9IHJlcXVpcmUoJy4vc2hvdy1hbGxlci5qc3gnKVxuICAsIEFkZENvbW1lbnQgPSByZXF1aXJlKCcuL2FkZC1jb21tZW50LmpzeCcpXG5cbnZhciBNYWluQ29tbWVudHMgPSBSZWFjdC5jcmVhdGVDbGFzcyh7ZGlzcGxheU5hbWU6ICdNYWluQ29tbWVudHMnLFxuICBtaXhpbnM6IFttaXhpbmddLFxuICBwcm9wVHlwZXM6IHtcbiAgICBkYjogUmVhY3QuUHJvcFR5cGVzLm9iamVjdC5pc1JlcXVpcmVkLFxuICAgIGF1dGg6IFJlYWN0LlByb3BUeXBlcy5hcnJheS5pc1JlcXVpcmVkXG4gIH0sXG4gIGdldEluaXRpYWxTdGF0ZTogZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiB7XG4gICAgICBzaG93QWxsOiBmYWxzZSxcbiAgICAgIGxvYWRpbmc6ICF0aGlzLnByb3BzLmRiLmxvYWRlZFxuICAgIH1cbiAgfSxcblxuICBjb21wb25lbnREaWRNb3VudDogZnVuY3Rpb24gKCkge1xuICAgIHRoaXMucHJvcHMuZGIub25Mb2dpbih0aGlzLl9vbkxvZ2luKVxuICAgIGlmICghdGhpcy5wcm9wcy5kYi5sb2FkZWQpIHtcbiAgICAgIHRoaXMucHJvcHMuZGIub25jZUxvYWRlZCh0aGlzLl9vbkxvYWRlZClcbiAgICB9XG4gIH0sXG5cbiAgY29tcG9uZW50V2lsbFVubW91bnQ6IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLnByb3BzLmRiLm9mZkxvZ2luKHRoaXMuX29uTG9naW4pXG4gIH0sXG5cbiAgX29uTG9hZGVkOiBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5zZXRTdGF0ZSh7bG9hZGluZzogZmFsc2V9KVxuICB9LFxuXG4gIF9vbkNoYW5nZVNob3c6IGZ1bmN0aW9uICh3aGljaCkge1xuICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgc2hvd0FsbDogd2hpY2hcbiAgICB9KVxuICB9LFxuXG4gIG9yZ2FuaXplQ29tbWVudHM6IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgaWRzID0gT2JqZWN0LmtleXModGhpcy5zdGF0ZS5jb21tZW50cylcbiAgICAgICwgY29tbWVudHMgPSB0aGlzLnN0YXRlLmNvbW1lbnRzXG4gICAgICAsIHNob3dBbGwgPSB0aGlzLnN0YXRlLnNob3dBbGxcbiAgICAgICwgaW5saW5lcyA9IDBcbiAgICAgICwgcmVwbGllcyA9IFtdXG4gICAgICAsIG1hcCA9IHt9XG4gICAgICAsIGxpc3QgPSBbXVxuXG4gICAgaWRzLmZvckVhY2goZnVuY3Rpb24gKGlkKSB7XG4gICAgICBpZiAoIWNvbW1lbnRzW2lkXSkgcmV0dXJuXG4gICAgICB2YXIgaXRlbSA9IHtcbiAgICAgICAgY29tbWVudDogY29tbWVudHNbaWRdLFxuICAgICAgICByZXBsaWVzOiBbXVxuICAgICAgfVxuICAgICAgdmFyIHRhcmdldCA9IGNvbW1lbnRzW2lkXS50YXJnZXRcbiAgICAgIG1hcFtpZF0gPSBpdGVtXG4gICAgICBpZiAodGFyZ2V0ID09PSAnbWFpbicpIHtcbiAgICAgICAgbGlzdC5wdXNoKGl0ZW0pXG4gICAgICB9IGVsc2UgaWYgKHRhcmdldC5pbmRleE9mKCdpbmxpbmU6JykgPT09IDApIHtcbiAgICAgICAgaW5saW5lcyArPSAxXG4gICAgICAgIGlmIChzaG93QWxsKSBsaXN0LnB1c2goaXRlbSlcbiAgICAgIH0gZWxzZSBpZiAodGFyZ2V0LmluZGV4T2YoJ3JlcGx5OicpID09PSAwKSB7XG4gICAgICAgIHJlcGxpZXMucHVzaChjb21tZW50c1tpZF0pXG4gICAgICB9XG4gICAgfSlcblxuICAgIHJlcGxpZXMuZm9yRWFjaChmdW5jdGlvbiAoY29tbWVudCkge1xuICAgICAgdmFyIHBhcmVudCA9IGNvbW1lbnQudGFyZ2V0LnNsaWNlKCdyZXBseTonLmxlbmd0aClcbiAgICAgIGlmICghbWFwW3BhcmVudF0pIHtcbiAgICAgICAgLy8gdGhpcyBpcyBpbiByZXBseSB0byBhIGNvbW1lbnQgdGhhdCB3YXMgZGVsZXRlZC4uLlxuICAgICAgICBsaXN0LnB1c2goe2NvbW1lbnQ6IGNvbW1lbnQsIHBhcmVudERlbGV0ZWQ6IHRydWUsIHJlcGxpZXM6IFtdfSlcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG4gICAgICBtYXBbcGFyZW50XS5yZXBsaWVzLnB1c2goY29tbWVudClcbiAgICB9KTtcblxuICAgIHJldHVybiB7XG4gICAgICBsaXN0OiBsaXN0LFxuICAgICAgaW5saW5lczogaW5saW5lc1xuICAgIH1cbiAgfSxcblxuICBfb25Mb2dpbjogZnVuY3Rpb24gKHVzZXIpIHtcbiAgICB0aGlzLnNldFN0YXRlKHt1c2VyOiB1c2VyfSlcbiAgfSxcblxuICByZW5kZXJDb21tZW50czogZnVuY3Rpb24gKCkge1xuICAgIGlmICghT2JqZWN0LmtleXModGhpcy5zdGF0ZS5jb21tZW50cykubGVuZ3RoKSB7XG4gICAgICBpZiAodGhpcy5zdGF0ZS5sb2FkaW5nKSB7XG4gICAgICAgIHJldHVybiBSZWFjdC5ET00uc3BhbihudWxsLCBSZWFjdC5ET00uaSgge2NsYXNzTmFtZTpcImZhIGZhLXNwaW4gZmEtc3Bpbm5lclwifSksIFwiIExvYWRpbmcuLi5cIilcbiAgICAgIH1cbiAgICAgIHJldHVybiBudWxsXG4gICAgfVxuXG4gICAgdmFyIG9yZ2FuaXplZCA9IHRoaXMub3JnYW5pemVDb21tZW50cygpXG4gICAgdmFyIHVzZXIgPSB0aGlzLnN0YXRlLnVzZXJcbiAgICB2YXIgZGIgPSB0aGlzLnByb3BzLmRiXG5cbiAgICB2YXIgY29tbWVudHMgPSBvcmdhbml6ZWQubGlzdC5tYXAoZnVuY3Rpb24gKGl0ZW0pIHtcbiAgICAgIHJldHVybiBDb21tZW50KHtcbiAgICAgICAga2V5OiBpdGVtLmNvbW1lbnQuX2lkLFxuICAgICAgICByZXBsaWVzOiBpdGVtLnJlcGxpZXMsXG4gICAgICAgIHBhcmVudERlbGV0ZWQ6IGl0ZW0ucGFyZW50RGVsZXRlZCxcbiAgICAgICAgY2FuRWRpdDogdXNlciAmJiB1c2VyLnVpZCA9PSBpdGVtLmNvbW1lbnQudXNlcmlkLFxuICAgICAgICBjYW5Wb3RlOiAhIXVzZXIsXG4gICAgICAgIHVzZXJpZDogdXNlciAmJiB1c2VyLnVpZCxcbiAgICAgICAgZGF0YTogaXRlbS5jb21tZW50LFxuICAgICAgICB1c2VyOiB1c2VyLFxuICAgICAgICBkYjogZGIsXG4gICAgICB9KVxuICAgIH0uYmluZCh0aGlzKSlcblxuICAgIHJldHVybiBSZWFjdC5ET00uZGl2KCB7Y2xhc3NOYW1lOlwiY29tbWVudGVkX2NvbW1lbnRzXCJ9LCBcbiAgICAgIG9yZ2FuaXplZC5pbmxpbmVzID8gU2hvd0FsbGVyKHtcbiAgICAgICAgY291bnQ6IG9yZ2FuaXplZC5pbmxpbmVzLFxuICAgICAgICBzaG93QWxsOiB0aGlzLnN0YXRlLnNob3dBbGwsXG4gICAgICAgIG9uQ2hhbmdlOiB0aGlzLl9vbkNoYW5nZVNob3dcbiAgICAgIH0pIDogZmFsc2UsXG4gICAgICBjb21tZW50c1xuICAgICk7XG4gIH0sXG5cbiAgcmVuZGVyOiBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIFJlYWN0LkRPTS5kaXYoIHtjbGFzc05hbWU6XCJjb21tZW50ZWRfbWFpblwifSwgXG4gICAgICB0aGlzLnJlbmRlckNvbW1lbnRzKCksXG4gICAgICBSZWFjdC5ET00uZGl2KCB7Y2xhc3NOYW1lOlwiY29tbWVudGVkX2FkZFwifSwgXG4gICAgICAgIEFkZENvbW1lbnQoXG4gICAgICAgICAge3RhcmdldDpcIm1haW5cIixcbiAgICAgICAgICB1c2VyOnRoaXMuc3RhdGUudXNlcixcbiAgICAgICAgICBhdXRoOnRoaXMucHJvcHMuYXV0aCxcbiAgICAgICAgICBkYjp0aGlzLnByb3BzLmRifSlcbiAgICAgICksXG4gICAgICBSZWFjdC5ET00uZGl2KCB7Y2xhc3NOYW1lOlwiY29tbWVudGVkX2F0dHJpYnV0aW9uXCJ9LCBcbiAgICAgICAgXCJDb21tZW50cyBwb3dlcmVkIGJ5IFwiLCBSZWFjdC5ET00uYSgge3RhcmdldDpcIl9ibGFua1wiLCBocmVmOlwiaHR0cDovL2NvbW1lbnRlZC5naXRodWIuaW9cIn0sIFwiLy9jb21tZW50ZWRcIilcbiAgICAgIClcbiAgICApO1xuICB9XG59KTtcblxubW9kdWxlLmV4cG9ydHMgPSBNYWluQ29tbWVudHM7XG4iLCJcbnZhciB1cCA9IFJlYWN0LmFkZG9ucy51cGRhdGVcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIHByb3BUeXBlczoge1xuICAgIGRiOiBSZWFjdC5Qcm9wVHlwZXMub2JqZWN0LmlzUmVxdWlyZWQsXG4gICAgYXV0aDogUmVhY3QuUHJvcFR5cGVzLmFycmF5LmlzUmVxdWlyZWRcbiAgfSxcblxuICBnZXRJbml0aWFsU3RhdGU6IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgY29tbWVudHM6IHt9LFxuICAgICAgdXNlcjogbnVsbFxuICAgIH1cbiAgfSxcblxuICBjb21wb25lbnREaWRNb3VudDogZnVuY3Rpb24gKCkge1xuICAgIHRoaXMucHJvcHMuZGIub25BZGQodGhpcy5fb25BZGRlZCk7XG4gICAgdGhpcy5wcm9wcy5kYi5vblJlbW92ZSh0aGlzLl9vblJlbW92ZWQpO1xuICAgIHRoaXMucHJvcHMuZGIub25DaGFuZ2UodGhpcy5fb25DaGFuZ2VkKTtcbiAgICB0aGlzLnNldFN0YXRlKHt1c2VyOiB0aGlzLnByb3BzLmRiLnVzZXJ9KTtcbiAgfSxcblxuICAvLyBmaXJlYmFzZSBjYWxsYmFja3NcbiAgX29uQWRkZWQ6IGZ1bmN0aW9uIChjb21tZW50KSB7XG4gICAgaWYgKHRoaXMucHJvcHMudGFyZ2V0ICYmIGNvbW1lbnQudGFyZ2V0ICE9PSB0aGlzLnByb3BzLnRhcmdldCkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIHZhciB1cGRhdGUgPSB7fVxuICAgIHVwZGF0ZVtjb21tZW50Ll9pZF0gPSB7JHNldDogY29tbWVudH1cbiAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgY29tbWVudHM6IHVwKHRoaXMuc3RhdGUuY29tbWVudHMsIHVwZGF0ZSlcbiAgICB9KVxuICB9LFxuXG4gIF9vbkNoYW5nZWQ6IGZ1bmN0aW9uIChjb21tZW50KSB7XG4gICAgdmFyIHVwZGF0ZSA9IHt9XG4gICAgdXBkYXRlW2NvbW1lbnQuX2lkXSA9IHskc2V0OiBjb21tZW50fVxuICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICBjb21tZW50czogdXAodGhpcy5zdGF0ZS5jb21tZW50cywgdXBkYXRlKVxuICAgIH0pXG4gIH0sXG5cbiAgX29uUmVtb3ZlZDogZnVuY3Rpb24gKGlkKSB7XG4gICAgdmFyIHVwZGF0ZSA9IHt9XG4gICAgdXBkYXRlW2lkXSA9IHskc2V0OiBudWxsfVxuICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICBjb21tZW50czogdXAodGhpcy5zdGF0ZS5jb21tZW50cywgdXBkYXRlKVxuICAgIH0pXG4gIH0sXG59XG4iLCIvKiogQGpzeCBSZWFjdC5ET00gKi9cbnZhciBMb2dpbiA9IHJlcXVpcmUoJy4vbG9naW4uanN4JylcblxudmFyIFJlcGx5TG9naW4gPSBSZWFjdC5jcmVhdGVDbGFzcyh7ZGlzcGxheU5hbWU6ICdSZXBseUxvZ2luJyxcbiAgcHJvcFR5cGVzOiB7XG4gICAgZGI6IFJlYWN0LlByb3BUeXBlcy5vYmplY3QuaXNSZXF1aXJlZCxcbiAgICBhdXRoOiBSZWFjdC5Qcm9wVHlwZXMuYXJyYXkuaXNSZXF1aXJlZCxcbiAgICBvbkNhbmNlbDogUmVhY3QuUHJvcFR5cGVzLmZ1bmMsXG4gICAgb25SZXBseTogUmVhY3QuUHJvcFR5cGVzLmZ1bmNcbiAgfSxcbiAgZ2V0SW5pdGlhbFN0YXRlOiBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG9wZW46IGZhbHNlXG4gICAgfVxuICB9LFxuICBvbk9wZW46IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLnByb3BzLm9uUmVwbHkoKVxuICAgIHRoaXMuc2V0U3RhdGUoe29wZW46IHRydWV9KVxuICB9LFxuICBvbkNhbmNlbDogZnVuY3Rpb24gKCkge1xuICAgIHRoaXMucHJvcHMub25DYW5jZWwoKVxuICAgIHRoaXMuc2V0U3RhdGUoe29wZW46IGZhbHNlfSlcbiAgfSxcbiAgcmVuZGVyOiBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIFJlYWN0LkRPTS5zcGFuKCB7Y2xhc3NOYW1lOlwiY29tbWVudGVkX3JlcGx5LWxvZ2luXCJ9LCBcbiAgICAgIHRoaXMuc3RhdGUub3BlbiA/XG4gICAgICAgIExvZ2luKFxuICAgICAgICAgIHtkYjp0aGlzLnByb3BzLmRiLFxuICAgICAgICAgIGF1dGg6dGhpcy5wcm9wcy5hdXRoLFxuICAgICAgICAgIG9uTG9naW46dGhpcy5wcm9wcy5vblJlcGx5LFxuICAgICAgICAgIG9uQ2FuY2VsOnRoaXMub25DYW5jZWx9XG4gICAgICAgICkgOlxuICAgICAgICBSZWFjdC5ET00uc3Bhbigge29uQ2xpY2s6dGhpcy5vbk9wZW4sIGNsYXNzTmFtZTpcImNvbW1lbnRlZF9yZXBseVwifSwgXCJyZXBseVwiKVxuICAgICAgXG4gICAgKVxuICB9LFxufSlcblxubW9kdWxlLmV4cG9ydHMgPSBSZXBseUxvZ2luXG4iLCIvKiogQGpzeCBSZWFjdC5ET00gKi9cbnZhciBTaG93QWxsZXIgPSBSZWFjdC5jcmVhdGVDbGFzcyh7ZGlzcGxheU5hbWU6ICdTaG93QWxsZXInLFxuICBwcm9wVHlwZXM6IHtcbiAgICBza2lwcGVkOiBSZWFjdC5Qcm9wVHlwZXMubnVtYmVyXG4gIH0sXG4gIHJlbmRlcjogZnVuY3Rpb24gKCkge1xuICAgIHZhciBzaG93ID0gdGhpcy5wcm9wcy5zaG93QWxsXG4gICAgcmV0dXJuIFJlYWN0LkRPTS5kaXYoIHtjbGFzc05hbWU6XCJjb21tZW50ZWRfc2hvdy1hbGxlclwifSwgXG4gICAgICBSZWFjdC5ET00uYnV0dG9uKFxuICAgICAgICAgIHtjbGFzc05hbWU6XCJjb21tZW50ZWRfc2hvdy1hbGxlcl9idG5cIixcbiAgICAgICAgICBvbkNsaWNrOnRoaXMucHJvcHMub25DaGFuZ2UuYmluZChudWxsLCAhc2hvdyl9LCBcbiAgICAgICAgc2hvdyA/ICdIaWRlJyA6ICdTaG93JywgXCIgXCIsIHRoaXMucHJvcHMuY291bnQsIFwiIHNpZGUgY29tbWVudHNcIlxuICAgICAgKVxuICAgICk7XG4gIH1cbn0pO1xuXG5tb2R1bGUuZXhwb3J0cyA9IFNob3dBbGxlclxuXG4iXX0=
